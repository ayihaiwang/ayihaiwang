# Windows å®‰è£…åŒ…æ„å»ºæŠ¥å‘Š

## ğŸ“‹ ç›®æ ‡

å°† warehouse-app å°è£…æˆ Windows å®‰è£…ç¨‹åºï¼ˆ.exe NSISï¼‰ï¼Œç”¨æˆ·åŒå‡»å®‰è£…åï¼š
- æ¡Œé¢/å¼€å§‹èœå•æœ‰å›¾æ ‡ï¼Œèƒ½å¯åŠ¨åº”ç”¨
- åº”ç”¨å¯åŠ¨åè‡ªåŠ¨æ‹‰èµ·æœ¬åœ°åç«¯æœåŠ¡ + æ‰“å¼€å‰ç«¯ç•Œé¢ï¼ˆä¸è¦æ±‚ç”¨æˆ·è£… Nodeï¼‰
- å¸è½½å¹²å‡€ï¼šèƒ½ä»"åº”ç”¨å’ŒåŠŸèƒ½"å¸è½½ï¼Œä¸æ®‹ç•™è¿›ç¨‹

---

## ğŸ”§ æ¶æ„ç¡®è®¤

**å½“å‰æ¶æ„**ï¼š
- Web å‰ç«¯ï¼šReact + Viteï¼ˆæ„å»ºåä¸ºé™æ€æ–‡ä»¶ï¼‰
- åç«¯æœåŠ¡ï¼šFastify + better-sqlite3ï¼ˆNode.jsï¼‰
- Electron å£³ï¼šåŠ è½½å‰ç«¯é¡µé¢ï¼Œå¯åŠ¨åç«¯æœåŠ¡

**å®ç°æ–¹æ¡ˆ**ï¼šElectron æ–¹æ¡ˆ
- Electron ä¸»è¿›ç¨‹å¯åŠ¨åç«¯æœåŠ¡å­è¿›ç¨‹ï¼ˆ`node server/index.js`ï¼‰
- åç«¯æœåŠ¡æä¾›é™æ€æ–‡ä»¶æœåŠ¡ï¼ˆ`@fastify/static`ï¼‰å’Œ API
- å‰ç«¯é€šè¿‡ HTTP è®¿é—®åç«¯ï¼ˆ`http://127.0.0.1:41731`ï¼‰
- æ‰“åŒ…ç”¨ electron-builderï¼ˆNSISï¼‰

---

## ğŸ“ ä¿®æ”¹æ¸…å•

### 1. Electron ä¸»è¿›ç¨‹ï¼š`electron/main.ts`

**æ”¹åŠ¨è¯´æ˜**ï¼šå®Œå…¨é‡å†™ï¼Œä» IPC ç›´æ¥è°ƒç”¨æ•°æ®åº“æ”¹ä¸ºå¯åŠ¨åç«¯æœåŠ¡å­è¿›ç¨‹

**å…³é”®é€»è¾‘**ï¼š

| åŠŸèƒ½ | å®ç°ä½ç½® | è¯´æ˜ |
|------|----------|------|
| å¯åŠ¨åç«¯æœåŠ¡ | `startBackendServer()` | ä½¿ç”¨ `spawn('node', [serverPath])` å¯åŠ¨åç«¯å­è¿›ç¨‹ |
| ç­‰å¾…æœåŠ¡å°±ç»ª | `checkHealth()` | è½®è¯¢ `/api/health`ï¼Œç›´åˆ°è¿”å› 200 |
| æ—¥å¿—è®°å½• | `getLogPath()` | æ—¥å¿—å†™å…¥ `%AppData%/warehouse-app/logs/app-YYYY-MM-DD.log` |
| åœæ­¢æœåŠ¡ | `stopBackendServer()` | åº”ç”¨é€€å‡ºæ—¶ `kill('SIGTERM')` ç»“æŸåç«¯è¿›ç¨‹ |
| çª—å£åŠ è½½ | `createWindow()` | ç”Ÿäº§ç¯å¢ƒåŠ è½½ `http://127.0.0.1:41731`ï¼ˆåç«¯æœåŠ¡ï¼‰ |

**è·¯å¾„å¤„ç†**ï¼š
- **å¼€å‘ç¯å¢ƒ**ï¼š`server/index.js` åœ¨ `../../server/index.js`
- **ç”Ÿäº§ç¯å¢ƒ**ï¼š`server/index.js` åœ¨ `resourcesPath/server/index.js`ï¼ˆelectron-builder çš„ extraResourcesï¼‰

**ä¸ºä»€ä¹ˆè¿™ä¹ˆæ”¹**ï¼š
- ç»Ÿä¸€æ¶æ„ï¼šWeb æ¨¡å¼å’Œ Electron æ¨¡å¼éƒ½ä½¿ç”¨ HTTP API
- ä»£ç å¤ç”¨ï¼šåç«¯é€»è¾‘åªéœ€ç»´æŠ¤ä¸€ä»½ï¼ˆ`server/`ï¼‰
- æ˜“äºè°ƒè¯•ï¼šåç«¯æ—¥å¿—ç‹¬ç«‹ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜

---

### 2. Electron Preloadï¼š`electron/preload.ts`

**æ”¹åŠ¨è¯´æ˜**ï¼šä» IPC è°ƒç”¨æ”¹ä¸º HTTP API è°ƒç”¨

**å…³é”®é€»è¾‘**ï¼š
- ä½¿ç”¨ `fetch()` è°ƒç”¨ `http://127.0.0.1:41731/api/*`
- é”™è¯¯å¤„ç†ï¼šè§£æ 4xx å“åº”ä½“ï¼ŒæŒ‚åˆ° `err.payload`
- å…¼å®¹æ€§ï¼šä¿æŒ `window.electronAPI` æ¥å£ä¸å˜

**ä¸ºä»€ä¹ˆè¿™ä¹ˆæ”¹**ï¼š
- ä¸ Web æ¨¡å¼ç»Ÿä¸€ï¼šéƒ½ä½¿ç”¨ HTTP API
- ç®€åŒ–ä»£ç ï¼šä¸éœ€è¦ç»´æŠ¤ä¸¤å¥— APIï¼ˆIPC + HTTPï¼‰

---

### 3. åç«¯æœåŠ¡ï¼š`server/index.js`

**æ”¹åŠ¨è¯´æ˜**ï¼šæ·»åŠ é™æ€æ–‡ä»¶æœåŠ¡å’Œ SPA è·¯ç”±å›é€€

**å…³é”®é€»è¾‘**ï¼š
```javascript
// ç”Ÿäº§ç¯å¢ƒæä¾›é™æ€æ–‡ä»¶
if (process.env.NODE_ENV === 'production') {
  fastify.register(require('@fastify/static'), {
    root: staticPath, // dist ç›®å½•
    prefix: '/',
  });
  // SPA è·¯ç”±å›é€€
  fastify.setNotFoundHandler((request, reply) => {
    if (request.url.startsWith('/api/')) {
      reply.code(404).send({ error: 'Not Found' });
    } else {
      reply.sendFile('index.html', staticPath);
    }
  });
}
```

**ä¸ºä»€ä¹ˆè¿™ä¹ˆæ”¹**ï¼š
- åç«¯æœåŠ¡åŒæ—¶æä¾›é™æ€æ–‡ä»¶å’Œ API
- Electron çª—å£åªéœ€åŠ è½½ `http://127.0.0.1:41731`ï¼Œæ— éœ€å•ç‹¬é…ç½®å‰ç«¯è·¯å¾„

---

### 4. æ•°æ®åº“è·¯å¾„ï¼š`server/db.js`

**æ”¹åŠ¨è¯´æ˜**ï¼šWindows ä¸‹ä½¿ç”¨ `%APPDATA%/warehouse-app/warehouse.db`

**å…³é”®é€»è¾‘**ï¼š
```javascript
if (process.platform === 'win32') {
  const appData = process.env.APPDATA || path.join(os.homedir(), 'AppData', 'Roaming');
  userDataDir = path.join(appData, 'warehouse-app');
} else {
  // Linux/Mac: ~/.local/share/warehouse-app
  const xdgDataDir = process.env.XDG_DATA_HOME || path.join(os.homedir(), '.local', 'share');
  userDataDir = path.join(xdgDataDir, 'warehouse-app');
}
```

**ä¸ºä»€ä¹ˆè¿™ä¹ˆæ”¹**ï¼š
- Windows æ ‡å‡†ï¼š`%APPDATA%` æ˜¯ Windows åº”ç”¨æ•°æ®ç›®å½•
- ç”¨æˆ·å¯å†™ï¼šé¿å…æƒé™é—®é¢˜
- å¸è½½ä¿ç•™ï¼šç”¨æˆ·æ•°æ®ä¸ä¼šè¢«åˆ é™¤

---

### 5. æ‰“åŒ…é…ç½®ï¼š`package.json`

**æ”¹åŠ¨è¯´æ˜**ï¼šé…ç½® electron-builderï¼ŒåŒ…å« server å’Œå¿…è¦ä¾èµ–

**å…³é”®é…ç½®**ï¼š

| é…ç½®é¡¹ | å€¼ | è¯´æ˜ |
|--------|-----|------|
| `appId` | `com.warehouse.app` | åº”ç”¨å”¯ä¸€æ ‡è¯† |
| `productName` | `å°ä»“åº“ç®¡ç†` | æ˜¾ç¤ºåç§° |
| `output` | `dist` | è¾“å‡ºç›®å½• |
| `win.target` | `nsis` (x64) | Windows NSIS å®‰è£…åŒ… |
| `nsis.oneClick` | `false` | å…è®¸è‡ªå®šä¹‰å®‰è£…ç›®å½• |
| `nsis.createDesktopShortcut` | `true` | åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼ |
| `nsis.createStartMenuShortcut` | `true` | åˆ›å»ºå¼€å§‹èœå•å¿«æ·æ–¹å¼ |
| `extraResources` | `server/**/*` | å°† server ç›®å½•å¤åˆ¶åˆ° resourcesPath |

**ä¸ºä»€ä¹ˆè¿™ä¹ˆæ”¹**ï¼š
- NSIS å®‰è£…åŒ…ï¼šWindows æ ‡å‡†å®‰è£…ç¨‹åºæ ¼å¼
- extraResourcesï¼šserver ç›®å½•ä¼šè¢«å¤åˆ¶åˆ°å®‰è£…ç›®å½•ï¼Œè¿è¡Œæ—¶å¯ç”¨
- å¿«æ·æ–¹å¼ï¼šç”¨æˆ·å®‰è£…åå¯ç›´æ¥å¯åŠ¨

---

### 6. æ„å»ºè„šæœ¬ï¼š`package.json`

**æ–°å¢è„šæœ¬**ï¼š
```json
"dist:win": "npm run compile && vite build && electron-builder --win --publish never"
```

**ä¸ºä»€ä¹ˆè¿™ä¹ˆæ”¹**ï¼š
- `compile`ï¼šç¼–è¯‘ Electron TypeScript ä»£ç 
- `vite build`ï¼šæ„å»ºå‰ç«¯é™æ€æ–‡ä»¶åˆ° `dist/`
- `electron-builder --win`ï¼šæ‰“åŒ… Windows å®‰è£…åŒ…

---

### 7. TypeScript é…ç½®ï¼š`tsconfig.electron.json`

**æ”¹åŠ¨è¯´æ˜**ï¼šæ·»åŠ  `"lib": ["ES2020", "DOM"]` å’Œ `"types": ["node"]`

**ä¸ºä»€ä¹ˆè¿™ä¹ˆæ”¹**ï¼š
- `DOM`ï¼špreload.ts ä¸­ä½¿ç”¨ `fetch`ã€`FormData` ç­‰ Web API
- `node`ï¼šmain.ts ä¸­ä½¿ç”¨ Node.js API

---

## ğŸš€ æ‰“åŒ…æ­¥éª¤

### æ­¥éª¤ 1ï¼šç¼–è¯‘ TypeScript

```bash
npm run compile
```

**äº§å‡º**ï¼š`dist-electron/main.js`ã€`dist-electron/preload.js`

---

### æ­¥éª¤ 2ï¼šæ„å»ºå‰ç«¯

```bash
npm run build
# æˆ–
vite build
```

**äº§å‡º**ï¼š`dist/` ç›®å½•ï¼ˆé™æ€æ–‡ä»¶ï¼‰

---

### æ­¥éª¤ 3ï¼šæ‰“åŒ… Windows å®‰è£…åŒ…

```bash
npm run dist:win
```

**äº§å‡º**ï¼š`dist/å°ä»“åº“ç®¡ç† Setup 1.0.0.exe`ï¼ˆNSIS å®‰è£…åŒ…ï¼‰

---

## ğŸ“¦ æ‰“åŒ…äº§ç‰©

**å®‰è£…åŒ…è·¯å¾„**ï¼š`dist/å°ä»“åº“ç®¡ç† Setup 1.0.0.exe`

**å®‰è£…åŒ…å†…å®¹**ï¼š
- Electron è¿è¡Œæ—¶
- å‰ç«¯é™æ€æ–‡ä»¶ï¼ˆ`dist/`ï¼‰
- Electron ä¸»è¿›ç¨‹ä»£ç ï¼ˆ`dist-electron/`ï¼‰
- åç«¯æœåŠ¡ä»£ç ï¼ˆ`server/`ï¼Œåœ¨ `resourcesPath/server/`ï¼‰
- å¿…è¦ä¾èµ–ï¼ˆbetter-sqlite3ã€fastify ç­‰ï¼Œé€šè¿‡ extraResources æˆ– asarUnpackï¼‰

**å®‰è£…ä½ç½®**ï¼ˆé»˜è®¤ï¼‰ï¼š
- Windowsï¼š`C:\Users\<ç”¨æˆ·å>\AppData\Local\Programs\warehouse-app\`

**æ•°æ®åº“ä½ç½®**ï¼š
- Windowsï¼š`%APPDATA%\warehouse-app\warehouse.db`
- å³ï¼š`C:\Users\<ç”¨æˆ·å>\AppData\Roaming\warehouse-app\warehouse.db`

**æ—¥å¿—ä½ç½®**ï¼š
- Windowsï¼š`%APPDATA%\warehouse-app\logs\app-YYYY-MM-DD.log`

---

## ğŸ§ª éªŒæ”¶æ­¥éª¤

### æ­¥éª¤ 1ï¼šå®‰è£…åº”ç”¨

**æ“ä½œ**ï¼š
1. åŒå‡» `dist/å°ä»“åº“ç®¡ç† Setup 1.0.0.exe`
2. é€‰æ‹©å®‰è£…ç›®å½•ï¼ˆæˆ–ä½¿ç”¨é»˜è®¤ï¼‰
3. å®Œæˆå®‰è£…

**é¢„æœŸ**ï¼š
- å®‰è£…æˆåŠŸ
- æ¡Œé¢æœ‰"å°ä»“åº“ç®¡ç†"å¿«æ·æ–¹å¼
- å¼€å§‹èœå•æœ‰"å°ä»“åº“ç®¡ç†"å…¥å£

**å®é™…ç»“æœ**ï¼š**å¾…éªŒè¯**ï¼ˆéœ€åœ¨ Windows ç¯å¢ƒæ‰§è¡Œï¼‰

---

### æ­¥éª¤ 2ï¼šå¯åŠ¨åº”ç”¨

**æ“ä½œ**ï¼š
1. åŒå‡»æ¡Œé¢å¿«æ·æ–¹å¼ï¼ˆæˆ–ä»å¼€å§‹èœå•å¯åŠ¨ï¼‰
2. ç­‰å¾…åº”ç”¨çª—å£æ‰“å¼€

**é¢„æœŸ**ï¼š
- åº”ç”¨çª—å£æ­£å¸¸æ‰“å¼€
- æ˜¾ç¤ºé¦–é¡µï¼ˆä¸å†å…¨ä¸º 0ï¼‰
- æ§åˆ¶å°æ— é”™è¯¯

**å®é™…ç»“æœ**ï¼š**å¾…éªŒè¯**

**éªŒè¯ç‚¹**ï¼š
- åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨ï¼ˆæ£€æŸ¥è¿›ç¨‹ï¼š`node.exe` è¿è¡Œ `server/index.js`ï¼‰
- ç«¯å£ 41731 æ˜¯å¦è¢«å ç”¨ï¼ˆ`netstat -ano | findstr 41731`ï¼‰
- æ—¥å¿—æ–‡ä»¶æ˜¯å¦ç”Ÿæˆï¼ˆ`%APPDATA%\warehouse-app\logs\`ï¼‰

---

### æ­¥éª¤ 3ï¼šåŠŸèƒ½éªŒè¯

**æ“ä½œ**ï¼š
1. æ–°å»ºç”³æŠ¥å•
2. æ–°å¢ç‰©èµ„ï¼ˆç”³æŠ¥å•å†…ï¼‰
3. æäº¤ç”³æŠ¥å•
4. æŸ¥çœ‹åº“å­˜é¡µ

**é¢„æœŸ**ï¼š
- æ‰€æœ‰åŠŸèƒ½æ­£å¸¸
- æ•°æ®èƒ½æ­£å¸¸å†™å…¥å’Œè¯»å–
- åˆ·æ–°åæ•°æ®ä»åœ¨

**å®é™…ç»“æœ**ï¼š**å¾…éªŒè¯**

---

### æ­¥éª¤ 4ï¼šæ•°æ®æŒä¹…åŒ–éªŒè¯

**æ“ä½œ**ï¼š
1. åˆ›å»ºä¸€äº›æ•°æ®ï¼ˆç”³æŠ¥å•ã€ç‰©èµ„ç­‰ï¼‰
2. å…³é—­åº”ç”¨
3. é‡æ–°å¯åŠ¨åº”ç”¨

**é¢„æœŸ**ï¼š
- æ•°æ®ä»åœ¨ï¼ˆæ•°æ®åº“æ–‡ä»¶å·²å†™å…¥ï¼‰
- æ•°æ®åº“æ–‡ä»¶ä½ç½®ï¼š`%APPDATA%\warehouse-app\warehouse.db`

**å®é™…ç»“æœ**ï¼š**å¾…éªŒè¯**

---

### æ­¥éª¤ 5ï¼šå¸è½½éªŒè¯

**æ“ä½œ**ï¼š
1. æ‰“å¼€"è®¾ç½®" -> "åº”ç”¨" -> "åº”ç”¨å’ŒåŠŸèƒ½"
2. æ‰¾åˆ°"å°ä»“åº“ç®¡ç†"ï¼Œç‚¹å‡»å¸è½½
3. å®Œæˆå¸è½½

**é¢„æœŸ**ï¼š
- å¸è½½æˆåŠŸ
- æ— æ®‹ç•™è¿›ç¨‹ï¼ˆ`node.exe` è¿›ç¨‹å·²ç»“æŸï¼‰
- ç«¯å£ 41731 ä¸å†å ç”¨
- ç”¨æˆ·æ•°æ®ä¿ç•™ï¼ˆæ•°æ®åº“æ–‡ä»¶ä»åœ¨ `%APPDATA%\warehouse-app\`ï¼‰

**å®é™…ç»“æœ**ï¼š**å¾…éªŒè¯**

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. Node.js ä¾èµ–

**å½“å‰æ–¹æ¡ˆ**ï¼šä½¿ç”¨ç³»ç»Ÿ `node` å‘½ä»¤å¯åŠ¨åç«¯æœåŠ¡

**è¦æ±‚**ï¼šWindows ç”¨æˆ·éœ€è¦å®‰è£… Node.jsï¼ˆæˆ–æ‰“åŒ…æ—¶åŒ…å« Node.js runtimeï¼‰

**æœªæ¥ä¼˜åŒ–**ï¼š
- å¯ä»¥ä½¿ç”¨ `electron-builder` çš„ `nodeGypRebuild` æˆ–æ‰“åŒ… Node.js runtime
- æˆ–ä½¿ç”¨ `pkg` å°† server æ‰“åŒ…æˆç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶

---

### 2. æ•°æ®åº“è¿ç§»

**å½“å‰å®ç°**ï¼š
- Windowsï¼š`%APPDATA%\warehouse-app\warehouse.db`
- å¦‚æœæ—§æ•°æ®åº“åœ¨ `~/.warehouse-app/warehouse.db`ï¼Œä¼šè‡ªåŠ¨è¿ç§»

**éªŒè¯**ï¼šé¦–æ¬¡è¿è¡Œåæ£€æŸ¥æ•°æ®åº“æ–‡ä»¶ä½ç½®

---

### 3. ç«¯å£å ç”¨

**å½“å‰å®ç°**ï¼šå›ºå®šç«¯å£ 41731

**é—®é¢˜**ï¼šå¦‚æœç«¯å£è¢«å ç”¨ï¼Œåç«¯æœåŠ¡å¯åŠ¨å¤±è´¥

**æœªæ¥ä¼˜åŒ–**ï¼šè‡ªåŠ¨æ¢æµ‹å¯ç”¨ç«¯å£ï¼Œæˆ–å…è®¸ç”¨æˆ·é…ç½®

---

### 4. æ—¥å¿—æ–‡ä»¶

**ä½ç½®**ï¼š`%APPDATA%\warehouse-app\logs/app-YYYY-MM-DD.log`

**ç”¨é€”**ï¼šæ’æŸ¥åç«¯æœåŠ¡å¯åŠ¨å¤±è´¥ã€API é”™è¯¯ç­‰é—®é¢˜

**æ¸…ç†**ï¼šæ—¥å¿—æ–‡ä»¶ä¸ä¼šè‡ªåŠ¨æ¸…ç†ï¼Œéœ€è¦æ‰‹åŠ¨åˆ é™¤æˆ–å®ç°æ—¥å¿—è½®è½¬

---

## ğŸ“„ æ€»ç»“

**å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

**ä¿®æ”¹æ–‡ä»¶**ï¼š
1. `electron/main.ts` - å¯åŠ¨åç«¯æœåŠ¡å­è¿›ç¨‹
2. `electron/preload.ts` - HTTP API è°ƒç”¨
3. `server/index.js` - é™æ€æ–‡ä»¶æœåŠ¡
4. `server/db.js` - Windows æ•°æ®åº“è·¯å¾„
5. `package.json` - electron-builder é…ç½®
6. `tsconfig.electron.json` - TypeScript é…ç½®

**æ‰“åŒ…å‘½ä»¤**ï¼š
```bash
npm run dist:win
```

**äº§ç‰©è·¯å¾„**ï¼š
- `dist/å°ä»“åº“ç®¡ç† Setup 1.0.0.exe`

**éªŒæ”¶çŠ¶æ€**ï¼š**å¾…éªŒè¯**ï¼ˆéœ€åœ¨ Windows ç¯å¢ƒæ‰§è¡Œå®‰è£…å’ŒåŠŸèƒ½æµ‹è¯•ï¼‰

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2026-02-18
