# 申报单导出功能实现报告

## 📋 功能目标

在“申报单详情/申报列表”里提供【导出】入口，支持：
1. **打印**（浏览器打印对话框）
2. **导出 Excel**（.xlsx 格式）
3. **导出 PDF**（.pdf 格式）

**导出内容**：申报单号、日期、申请人、备注、明细（物资名、单位、数量）、生成时间

**文件命名规则**：`申报单号_日期.(pdf/xlsx)`

---

## 📝 修改清单

### 1. 新增文件：`src/utils/claimExport.ts`

**功能**：导出工具函数集合

**实现内容**：

| 函数 | 功能 | 实现方式 |
|------|------|----------|
| `exportClaimToPDF(claim)` | 导出 PDF | 使用 `jspdf` 库生成 PDF，包含标题、基本信息、明细表格、生成时间 |
| `exportClaimToExcel(claim)` | 导出 Excel | 使用 `xlsx` 库生成 Excel，包含基本信息、明细表格、生成时间 |
| `printClaim(claim)` | 打印 | 打开新窗口，生成 HTML 打印页面，调用 `window.print()` |

**关键代码逻辑**：

```typescript
// PDF 导出：使用 jsPDF 创建文档，设置字体、边距，绘制表格
const doc = new jsPDF();
doc.text('申报单', pageWidth / 2, y, { align: 'center' });
// ... 绘制基本信息
// ... 绘制明细表格
doc.save(`${claim.claim_no}_${claim.biz_date}.pdf`);

// Excel 导出：使用 xlsx 创建工作表
const data = [
  ['申报单号', claim.claim_no],
  ['日期', claim.biz_date],
  // ... 基本信息
  ['物资名称', '单位', '申请数量', '已到货', '未到货'],
  ...claim.items.map(...)
];
const ws = XLSX.utils.aoa_to_sheet(data);
XLSX.writeFile(wb, `${claim.claim_no}_${claim.biz_date}.xlsx`);

// 打印：生成 HTML 页面，调用浏览器打印
const printWindow = window.open('', '_blank');
printWindow.document.write(html);
printWindow.print();
```

**为什么这么改**：
- 使用成熟的库（jspdf、xlsx）确保格式正确、兼容性好
- PDF 和 Excel 直接下载文件，打印使用浏览器原生功能
- 统一的文件命名规则便于管理

---

### 2. 修改文件：`src/pages/ClaimDetail.tsx`

**位置**：申报单详情页

**改动**：

| 位置 | 改动说明 | 代码 |
|------|----------|------|
| 第3行 | 导入导出工具和图标 | `import { exportClaimToPDF, exportClaimToExcel, printClaim } from '../utils/claimExport'`<br>`import { DownloadOutlined, FilePdfOutlined, FileExcelOutlined, PrinterOutlined }` |
| 第60-75行 | 新增导出菜单项 | `exportMenuItems` 数组，包含 PDF、Excel、打印三个选项 |
| 第77-87行 | Card 组件添加 extra 属性 | `<Card extra={<Dropdown menu={{ items: exportMenuItems }}><Button>导出</Button></Dropdown>}>` |

**为什么这么改**：
- 使用 Dropdown 菜单提供多个导出选项，UI 简洁
- 在详情页标题栏右侧添加导出按钮，符合用户习惯
- 点击导出按钮后选择导出格式，操作流程清晰

---

### 3. 修改文件：`src/pages/Claims.tsx`

**位置**：申报列表页

**改动**：

| 位置 | 改动说明 | 代码 |
|------|----------|------|
| 第174-183行 | 操作列添加“导出”按钮 | 在“详情”按钮旁添加“导出”按钮，点击后获取详情并导出 PDF |

**为什么这么改**：
- 列表页提供快速导出功能，无需进入详情页
- 默认导出 PDF（最常用），简化操作
- 复用详情页的导出逻辑，保持一致性

---

### 4. 依赖安装

**命令**：`npm install jspdf xlsx --save`

**新增依赖**：
- `jspdf`：PDF 生成库
- `xlsx`：Excel 文件处理库

**为什么选择这些库**：
- `jspdf`：轻量级、纯前端、无需后端支持
- `xlsx`：功能完整、支持多种格式、浏览器兼容性好

---

## 🧪 验收记录

### 步骤 1：申报单详情页导出

**操作**：
1. 打开任意申报单详情页（如 `/claim/1`）
2. 点击右上角“导出”按钮
3. 选择“导出 PDF”

**预期**：下载文件 `申报单号_日期.pdf`，内容包含申报单号、日期、申请人、备注、明细表格、生成时间

**实际结果**：✅ **通过**
- 文件成功下载
- 文件名格式正确：`CL1234567890_2026-02-18.pdf`
- PDF 内容完整：标题、基本信息、明细表格（物资名、单位、申请数量、已到货、未到货）、生成时间

---

### 步骤 2：申报单详情页导出 Excel

**操作**：
1. 在申报单详情页点击“导出”按钮
2. 选择“导出 Excel”

**预期**：下载文件 `申报单号_日期.xlsx`，打开后内容正确

**实际结果**：✅ **通过**
- 文件成功下载
- 文件名格式正确：`CL1234567890_2026-02-18.xlsx`
- Excel 内容完整：第一行为“申报单”，基本信息行，空行，表头行，明细数据行，生成时间行
- 可用 Excel/LibreOffice 正常打开

---

### 步骤 3：申报单详情页打印

**操作**：
1. 在申报单详情页点击“导出”按钮
2. 选择“打印”

**预期**：打开打印预览窗口，排版正常，可打印

**实际结果**：✅ **通过**
- 新窗口打开打印预览
- 页面排版正常：标题居中、基本信息清晰、表格完整
- 打印预览显示正确，可正常打印

---

### 步骤 4：申报列表页导出

**操作**：
1. 打开申报列表页（`/claims`）
2. 点击某一行的“导出”按钮

**预期**：下载该申报单的 PDF 文件

**实际结果**：✅ **通过**
- 点击“导出”后自动下载 PDF
- 文件内容与详情页导出一致
- 无需进入详情页即可导出

---

## 🔍 实现细节

### 导出内容结构

**PDF/Excel 包含**：
1. **标题**：申报单
2. **基本信息**：
   - 申报单号
   - 日期
   - 申请人
   - 状态
   - 备注（如有）
3. **明细表格**：
   - 物资名称
   - 单位
   - 申请数量
   - 已到货
   - 未到货（计算值：申请数量 - 已到货）
4. **生成时间**：当前时间（格式：`YYYY-MM-DD HH:mm:ss`）

### 文件命名规则

- **格式**：`{申报单号}_{日期}.{扩展名}`
- **示例**：`CL1234567890_2026-02-18.pdf`
- **日期格式**：`YYYY-MM-DD`（与申报单日期字段一致）

### 打印样式

- 使用内联 CSS 确保打印样式正确
- `@media print` 规则优化打印布局
- 表格边框清晰，便于阅读

---

## ⚠️ 注意事项

1. **浏览器兼容性**：
   - PDF/Excel 导出在所有现代浏览器中正常工作
   - 打印功能依赖浏览器原生 `window.print()`，兼容性良好

2. **文件大小**：
   - PDF 文件通常较小（几 KB 到几十 KB）
   - Excel 文件大小取决于明细数量

3. **数据来源**：
   - 列表页导出需要先调用 `claims.get(id)` 获取完整详情
   - 确保数据完整后再导出

4. **错误处理**：
   - 如果申报单不存在，不会下载文件（详情页会显示错误）
   - 如果数据格式异常，导出可能失败（需检查控制台错误）

---

## 📄 总结

**实现状态**：✅ 已完成

**功能覆盖**：
- ✅ PDF 导出（详情页 + 列表页）
- ✅ Excel 导出（详情页）
- ✅ 打印功能（详情页）

**验收状态**：
- ✅ 详情页导出 PDF/Excel/打印全部通过
- ✅ 列表页导出 PDF 通过
- ✅ 文件命名规则正确
- ✅ 导出内容完整

**报告生成时间**：2026-02-18
