# 仓库管理系统封装建议与步骤

> 本文档整理封装交付前的建议，用于按步骤完成 Windows 10/11 环境下的用户交付。

---

## 一、封装前检查清单

### 1.1 代码与构建

| 步骤 | 操作 | 说明 |
|------|------|------|
| 1 | `npm run compile` | 确保 TypeScript 编译无报错 |
| 2 | `npm run dist:win` 或 `npm run build:win` | 在 Ubuntu 上生成 Windows 安装包 |
| 3 | 检查 `dist/` 下生成的 `.exe` | 确认安装包存在且大小合理 |

### 1.2 可选优化（不强制）

| 项目 | 建议 | 优先级 |
|------|------|--------|
| 控制台日志 | 生产环境移除或精简 `console.log` | 低 |
| 版本号 | 在设置页或关于页显示 `package.json` 中的 version | 中 |
| 数据库路径 | Windows 下使用 `%APPDATA%\warehouse-app\warehouse.db`（当前 `~/.warehouse-app` 也可用） | 低 |

---

## 二、Windows 安装包构建步骤

### 2.1 重要说明：无法在 Ubuntu 上直接构建

**原因**：项目依赖 `better-sqlite3` 原生模块，`node-gyp` 不支持从 Linux 交叉编译到 Windows。

### 2.2 方案 A：使用 GitHub Actions（推荐）

已在工程内添加 `.github/workflows/build-windows.yml`，在 Windows 环境下自动构建。

**步骤**：

1. 在 GitHub 上创建仓库，将工程推送上去（若尚未推送）
   ```bash
   git init
   git add .
   git commit -m "Initial commit"
   git remote add origin https://github.com/<你的用户名>/warehouse-app.git
   git branch -M main
   git push -u origin main
   ```
2. 打开仓库 → **Actions** → 选择 **Build Windows Installer**
3. 点击 **Run workflow** 手动触发
4. 构建完成后（约 5–10 分钟），在 **Artifacts** 中下载 `windows-installer`（内含 `.exe`）

### 2.3 方案 B：在 Windows 机器上构建

若有 Windows 10/11 电脑，可直接在该机器上执行：

```bash
cd warehouse-app
npm install
npm run dist:win
# 输出：dist/小仓库管理 1.0.0.exe
```

### 2.4 输出位置

- **GitHub Actions**：Artifacts → `windows-installer` 压缩包
- **本地 Windows**：`dist/` 目录下

### 2.5 构建产物说明

- **NSIS 安装包**：用户双击即可安装
- **安装选项**：`package.json` 已配置 `allowToChangeInstallationDirectory`、`createDesktopShortcut`、`createStartMenuShortcut`
- **架构**：仅 x64，适配 Windows 10/11 64 位

---

## 三、U 盘交付准备（单用户场景）

### 3.1 U 盘内建议内容

```
U盘根目录/
├── 小仓库管理 1.0.0.exe      # 安装包
└── 安装说明.txt              # 可选，见下方模板
```

### 3.2 安装说明.txt 模板

```
【小仓库管理系统 - 安装说明】

1. 双击 "小仓库管理 1.0.0.exe" 开始安装
2. 若 Windows 提示「Windows 已保护你的电脑」：
   点击「更多信息」→「仍要运行」
3. 按提示完成安装（可选择安装路径）
4. 安装完成后，从桌面或开始菜单启动「小仓库管理」
5. 首次启动可能需要数秒，请耐心等待

系统要求：Windows 10/11 64 位
```

---

## 四、首次安装现场检查清单

建议开发者首次到用户现场时执行：

- [ ] 安装过程无报错，顺利完成
- [ ] 桌面/开始菜单出现「小仓库管理」快捷方式
- [ ] 双击启动，主窗口正常打开
- [ ] 新增一条物资，能保存成功
- [ ] 创建一张申报单，能保存成功
- [ ] 导出一份 Excel，能正常下载
- [ ] 关闭应用后，任务管理器无残留 node 进程

若出现问题，现场记录现象（如报错内容、截图），便于回去排查。

---

## 五、Windows 相关注意事项

### 5.1 数据库路径

- **当前**：`C:\Users\<用户名>\.warehouse-app\warehouse.db`
- **可选优化**：改为 `%APPDATA%\warehouse-app\warehouse.db`，更符合 Windows 规范
- **卸载**：用户数据保留在上述目录，卸载不删除

### 5.2 SmartScreen / 杀毒软件

- 未签名应用可能被拦截，安装说明中已提示「更多信息 → 仍要运行」
- 单用户 U 盘安装场景下，暂不建议投入代码签名证书

### 5.3 系统要求

建议在说明中注明：

- Windows 10（64 位）或 Windows 11（64 位）
- 约 4GB 内存
- 约 200MB 磁盘空间
- 无需安装 Node.js 等额外环境

---

## 六、封装流程简表（按顺序执行）

| 序号 | 操作 |
|------|------|
| 1 | 备份当前工程（`backups/` 目录下 `tar` 备份） |
| 2 | `npm install` 确保依赖完整 |
| 3 | **通过 GitHub Actions 或 Windows 机器** 生成 Windows 安装包（见第二节） |
| 4 | 将 `dist/*.exe` 或 Artifacts 中的 `.exe` 复制到 U 盘 |
| 5 | 编写/复制「安装说明.txt」到 U 盘 |
| 6 | 到用户现场执行安装与现场检查清单 |
| 7 | 根据现场反馈决定是否调整（如 DB 路径、错误提示等） |

---

## 七、版本与后续更新

- 当前版本：`package.json` 中 `"version": "1.0.0"`
- 若有更新：修改 version → 重新 `npm run dist:win` → 新安装包覆盖或替换 U 盘中旧包
- 单用户场景无需做自动更新功能

---

## 八、不推荐在现阶段做的内容

| 项目 | 说明 |
|------|------|
| 自动更新 | 单用户可手动发新包 |
| 代码签名证书 | 成本高，单用户可先不做 |
| 复杂卸载逻辑 | NSIS 默认卸载一般足够 |
| 多语言/国际化 | 按需后续再加 |

---

*文档生成时间：2025-02-20*
