# å‘å¸ƒåå¢å¼ºä¼˜åŒ– - ä¿®å¤æ€»ç»“

> ä¿®å¤æ—¶é—´ï¼š2026-02-20  
> ç›®æ ‡ï¼šå‡å°å®‰è£…åŒ…ä½“ç§¯ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

---

## âœ… ä¼˜åŒ– 1: tsx ä» production ä¾èµ–ç§»å› devDependencies

### ä¿®æ”¹æ–‡ä»¶
- `package.json` - å°† tsx ä» dependencies ç§»åˆ° devDependencies

### å…³é”® diff

```diff
  "dependencies": {
    "@fastify/cors": "^9.0.1",
    "@fastify/multipart": "^8.3.1",
    "@fastify/static": "^9.0.0",
    "antd": "^5.21.0",
    "better-sqlite3": "^11.5.0",
    "dayjs": "^1.11.13",
    "echarts": "^5.5.0",
    "echarts-for-react": "^3.0.2",
    "electron": "27.3.11",
    "exceljs": "^4.4.0",
    "fastify": "^4.29.1",
    "html2canvas": "^1.4.1",
    "jspdf": "^4.1.0",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-resizable": "^3.1.3",
    "react-router-dom": "^6.28.0",
-   "tsx": "^4.21.0",
    "xlsx": "^0.18.5"
  },
  "devDependencies": {
+   "tsx": "^4.21.0",
    "@types/better-sqlite3": "^7.6.11",
    "@types/node": "^22.9.0",
    "@types/react": "^18.3.12",
    "@types/react-dom": "^18.3.1",
    "@types/react-resizable": "^3.0.8",
    "@vitejs/plugin-react": "^4.3.3",
    "concurrently": "^9.0.1",
    "electron-builder": "^25.1.8",
    "electron-rebuild": "^3.2.9",
    "rimraf": "^5.0.5",
    "typescript": "^5.6.3",
    "vite": "^5.4.10",
    "wait-on": "^8.0.1"
  }
```

### éªŒè¯æ­¥éª¤

1. **é‡æ–°å®‰è£…ä¾èµ–**ï¼š
   ```powershell
   Remove-Item -Recurse -Force node_modules -ErrorAction SilentlyContinue
   npm install
   ```

2. **éªŒè¯ tsx ä½ç½®**ï¼š
   ```powershell
   npm list tsx --depth=0
   ```
   é¢„æœŸï¼štsx åœ¨ devDependencies ä¸­

3. **æ‰§è¡Œæ„å»º**ï¼š
   ```powershell
   npm run server:build
   npm run rebuild:native
   npm run compile
   npm run build
   npm run dist:win
   ```

4. **å¯¹æ¯”å®‰è£…åŒ…ä½“ç§¯**ï¼š
   ```powershell
   # æ„å»ºå‰è®°å½•ä½“ç§¯ï¼ˆå¦‚æœæœ‰æ—§ç‰ˆæœ¬ï¼‰
   # æ„å»ºåæ£€æŸ¥ä½“ç§¯
   Get-Item "dist\ä»“åº“ç®¡ç†-1.0.0-Setup.exe" | Select-Object Length
   ```
   é¢„æœŸï¼šå®‰è£…åŒ…ä½“ç§¯åº”ç•¥æœ‰å‡å°ï¼ˆtsx åŠå…¶ä¾èµ–ä¸å†æ‰“åŒ…ï¼‰

5. **éªŒè¯è¿è¡Œ**ï¼š
   - å®‰è£…å¹¶å¯åŠ¨åº”ç”¨
   - ç¡®è®¤æ— æŠ¥é”™
   - ç¡®è®¤ production ä¸å† require tsxï¼ˆæ£€æŸ¥æ—¥å¿—æ—  tsx ç›¸å…³é”™è¯¯ï¼‰

### å®‰è£…åŒ…ä½“ç§¯å¯¹æ¯”è¯´æ˜

**é¢„æœŸå˜åŒ–**ï¼š
- tsx åŠå…¶ä¾èµ–ï¼ˆå¦‚ esbuildï¼‰ä¸å†æ‰“åŒ…åˆ° production
- å®‰è£…åŒ…ä½“ç§¯é¢„è®¡å‡å°‘ 5-10MBï¼ˆå–å†³äº tsx çš„ä¾èµ–å¤§å°ï¼‰
- å®é™…å‡å°‘é‡å–å†³äº tsx çš„ä¾èµ–æ ‘

---

## âœ… ä¼˜åŒ– 2: å¢åŠ åç«¯å¼‚å¸¸é€€å‡ºæç¤º

### ä¿®æ”¹æ–‡ä»¶
- `electron/main.ts` - æ·»åŠ  dialog å¯¼å…¥å’Œå¼‚å¸¸é€€å‡ºå¤„ç†

### å…³é”® diff

**å¯¼å…¥ dialog**ï¼š
```diff
- import { app, BrowserWindow } from 'electron';
+ import { app, BrowserWindow, dialog } from 'electron';
```

**æ·»åŠ å¯åŠ¨å®Œæˆæ ‡è®°**ï¼š
```diff
    let healthCheckStarted = false;
    let timeoutId: NodeJS.Timeout | null = null;
+   let isStartupComplete = false; // æ ‡è®°å¯åŠ¨æ˜¯å¦å®Œæˆ
```

**å¥åº·æ£€æŸ¥æˆåŠŸåæ ‡è®°å¯åŠ¨å®Œæˆ**ï¼š
```diff
            console.log(`[Electron] åç«¯æœåŠ¡å·²å°±ç»ª: ${actualBackendURL}`);
            logStream.write(`[INFO] å¥åº·æ£€æŸ¥é€šè¿‡: ${actualBackendURL}/api/health\n`);
-           logStream.end();
            if (timeoutId) clearTimeout(timeoutId);
+           timeoutId = null; // æ¸…é™¤ timeoutIdï¼Œæ ‡è®°å¯åŠ¨å®Œæˆ
+           isStartupComplete = true;
            resolve();
            return;
```

**exit äº‹ä»¶å¤„ç†å¢å¼º**ï¼š
```diff
    backendProcess.on('exit', (code: number) => {
-     console.log(`[Electron] åç«¯æœåŠ¡é€€å‡ºï¼Œä»£ç : ${code}`);
-     logStream.write(`[EXIT] ä»£ç : ${code}\n`);
-     logStream.end();
-     backendProcess = null;
-     if (timeoutId) clearTimeout(timeoutId);
-     if (code !== 0 && code !== null) {
-       reject(new Error(`åç«¯æœåŠ¡å¼‚å¸¸é€€å‡ºï¼Œä»£ç : ${code}`));
-     }
+     const isStartupPhase = !isStartupComplete;
+     console.log(`[Electron] åç«¯æœåŠ¡é€€å‡ºï¼Œä»£ç : ${code}`);
+     logStream.write(`[EXIT] ä»£ç : ${code}\n`);
+     logStream.write(`[EXIT] é€€å‡ºæ—¶é—´: ${new Date().toISOString()}\n`);
+     
+     if (isStartupPhase) {
+       // å¯åŠ¨é˜¶æ®µçš„é€€å‡ºå¤„ç†
+       logStream.end();
+       if (timeoutId) clearTimeout(timeoutId);
+       backendProcess = null;
+       if (code !== 0 && code !== null) {
+         reject(new Error(`åç«¯æœåŠ¡å¼‚å¸¸é€€å‡ºï¼Œä»£ç : ${code}`));
+       }
+     } else {
+       // è¿è¡ŒæœŸé—´çš„é€€å‡ºå¤„ç†ï¼ˆåç«¯å´©æºƒï¼‰
+       logStream.write(`[ERROR] åç«¯è¿›ç¨‹åœ¨è¿è¡ŒæœŸé—´å¼‚å¸¸é€€å‡º\n`);
+       logStream.end();
+       backendProcess = null;
+       
+       // åªæœ‰éæ­£å¸¸é€€å‡ºï¼ˆcode !== 0ï¼‰ä¸”çª—å£å­˜åœ¨æ—¶æ‰æ˜¾ç¤ºé”™è¯¯æç¤º
+       if (code !== 0 && code !== null && mainWindow && !mainWindow.isDestroyed()) {
+         const logPath = getLogPath();
+         console.error(`[Electron] åç«¯è¿›ç¨‹å¼‚å¸¸é€€å‡ºï¼Œé€€å‡ºç : ${code}`);
+         
+         // æ˜¾ç¤ºé”™è¯¯æç¤º
+         dialog.showErrorBox(
+           'åç«¯æœåŠ¡å¼‚å¸¸é€€å‡º',
+           `åç«¯æœåŠ¡æ„å¤–å…³é—­ï¼Œè¯·é‡å¯åº”ç”¨ã€‚\n\né€€å‡ºç : ${code}\n\nè¯·æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶è·å–è¯¦ç»†ä¿¡æ¯ï¼š\n${logPath}`
+         );
+       }
+     }
    });
```

### éªŒè¯æ­¥éª¤

1. **æ„å»ºå¹¶å®‰è£…åº”ç”¨**ï¼š
   ```powershell
   npm run dist:win
   # å®‰è£… dist\ä»“åº“ç®¡ç†-1.0.0-Setup.exe
   ```

2. **å¯åŠ¨åº”ç”¨**ï¼šä»æ¡Œé¢æˆ–å¼€å§‹èœå•å¯åŠ¨åº”ç”¨

3. **æ‰‹åŠ¨ç»ˆæ­¢åç«¯è¿›ç¨‹**ï¼š
   ```powershell
   # æŸ¥æ‰¾åç«¯è¿›ç¨‹ PID
   Get-Process | Where-Object {$_.ProcessName -eq "node"} | Select-Object Id, ProcessName
   
   # ç»ˆæ­¢è¿›ç¨‹ï¼ˆæ›¿æ¢ <PID> ä¸ºå®é™… PIDï¼‰
   Stop-Process -Id <PID> -Force
   ```

4. **éªŒè¯é”™è¯¯æç¤º**ï¼š
   - åº”å¼¹å‡ºé”™è¯¯å¯¹è¯æ¡†
   - æ ‡é¢˜ï¼š`åç«¯æœåŠ¡å¼‚å¸¸é€€å‡º`
   - å†…å®¹åŒ…å«ï¼šé€€å‡ºç å’Œæ—¥å¿—æ–‡ä»¶è·¯å¾„

5. **æ£€æŸ¥æ—¥å¿—**ï¼š
   ```powershell
   Get-Content "$env:APPDATA\warehouse-app\logs\app-*.log" -Tail 10
   ```
   é¢„æœŸæ—¥å¿—å†…å®¹ï¼š
   ```
   [EXIT] ä»£ç : <é0é€€å‡ºç >
   [EXIT] é€€å‡ºæ—¶é—´: 2026-02-20T...
   [ERROR] åç«¯è¿›ç¨‹åœ¨è¿è¡ŒæœŸé—´å¼‚å¸¸é€€å‡º
   ```

6. **éªŒè¯æ­£å¸¸é€€å‡ºä¸å¼¹çª—**ï¼š
   - æ­£å¸¸å…³é—­åº”ç”¨ï¼ˆç‚¹å‡»çª—å£å…³é—­æŒ‰é’®ï¼‰
   - ä¸åº”å¼¹å‡ºé”™è¯¯æç¤º
   - æ—¥å¿—ä¸­ exit ä»£ç åº”ä¸º 0 æˆ– null

---

## ğŸ“‹ æœ€ç»ˆéªŒè¯æµç¨‹

### 1. æ„å»ºéªŒè¯

```powershell
cd "D:\ä»“åº“ç®¡ç†\warehouse-app"

# æ¸…ç†å¹¶é‡æ–°å®‰è£…
Remove-Item -Recurse -Force node_modules -ErrorAction SilentlyContinue
npm install

# éªŒè¯ tsx åœ¨ devDependencies
npm list tsx --depth=0

# æ‰§è¡Œæ„å»º
npm run server:build
npm run rebuild:native
npm run compile
npm run build
npm run dist:win
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… tsx åœ¨ devDependencies ä¸­
- âœ… æ„å»ºæˆåŠŸï¼Œç”Ÿæˆ `dist\ä»“åº“ç®¡ç†-1.0.0-Setup.exe`
- âœ… å®‰è£…åŒ…ä½“ç§¯ç•¥æœ‰å‡å°

### 2. å®‰è£…éªŒè¯

1. **åŒå‡»å®‰è£…åŒ…**ï¼š`dist\ä»“åº“ç®¡ç†-1.0.0-Setup.exe`
2. **é€‰æ‹©å®‰è£…ç›®å½•**ï¼ˆå¯é€‰ï¼‰
3. **ç­‰å¾…å®‰è£…å®Œæˆ**

**é¢„æœŸç»“æœ**ï¼š
- âœ… å®‰è£…æˆåŠŸ
- âœ… å¿«æ·æ–¹å¼åˆ›å»ºæˆåŠŸ

### 3. å¯åŠ¨éªŒè¯

1. **ä»æ¡Œé¢æˆ–å¼€å§‹èœå•å¯åŠ¨åº”ç”¨**
2. **ç­‰å¾…çª—å£æ‰“å¼€**ï¼ˆ3-5 ç§’ï¼‰

**é¢„æœŸç»“æœ**ï¼š
- âœ… çª—å£æ­£å¸¸æ‰“å¼€
- âœ… æ— é”™è¯¯å¼¹çª—
- âœ… ç•Œé¢æ­£å¸¸æ˜¾ç¤º

### 4. æ•°æ®åº“è·¯å¾„éªŒè¯

```powershell
$dbPath = "$env:APPDATA\warehouse-app\warehouse.db"
Test-Path $dbPath
Get-Item $dbPath | Select-Object FullName
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ•°æ®åº“æ–‡ä»¶åœ¨ï¼š`C:\Users\<ç”¨æˆ·å>\AppData\Roaming\warehouse-app\warehouse.db`

### 5. å¼‚å¸¸é€€å‡ºæç¤ºéªŒè¯

```powershell
# å¯åŠ¨åº”ç”¨åï¼ŒæŸ¥æ‰¾åç«¯è¿›ç¨‹
$nodeProcesses = Get-Process | Where-Object {$_.ProcessName -eq "node"}
$nodeProcesses | Select-Object Id, ProcessName, StartTime

# ç»ˆæ­¢åç«¯è¿›ç¨‹ï¼ˆæ›¿æ¢ <PID> ä¸ºå®é™… PIDï¼‰
Stop-Process -Id <PID> -Force

# éªŒè¯é”™è¯¯æç¤ºå¼¹å‡º
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… å¼¹å‡ºé”™è¯¯å¯¹è¯æ¡†
- âœ… æ˜¾ç¤ºé€€å‡ºç å’Œæ—¥å¿—è·¯å¾„
- âœ… æ—¥å¿—è®°å½•å¼‚å¸¸é€€å‡ºä¿¡æ¯

---

## âœ… ä¼˜åŒ–å®Œæˆæ¸…å•

- [x] ä¼˜åŒ– 1: tsx ç§»åˆ° devDependenciesï¼ˆå‡å°ä½“ç§¯ï¼‰
- [x] ä¼˜åŒ– 2: åç«¯å¼‚å¸¸é€€å‡ºæç¤ºï¼ˆæå‡ç”¨æˆ·ä½“éªŒï¼‰

---

**æ‰€æœ‰ä¼˜åŒ–å·²å®Œæˆï¼å¯ä»¥å¼€å§‹æœ€ç»ˆæ„å»ºå’Œå‘å¸ƒï¼** âœ…
