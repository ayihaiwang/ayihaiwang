# Windows 安装包封装完成说明

> 生成时间：2026-02-20  
> 目标：制作兼容 Windows 10/11 的傻瓜安装包，所有运行环境封装在安装包中

---

## ✅ 一、配置优化完成

### 1.1 打包配置优化

**已优化项**：
- ✅ 启用 ASAR 打包（减小体积，提升性能）
- ✅ 确保所有运行时依赖打包（tsx、better-sqlite3等）
- ✅ 配置 asarUnpack 确保原生模块正确解包
- ✅ 优化文件包含规则，排除不必要的文件

**关键配置**：
```json
{
  "asar": true,
  "asarUnpack": [
    "**/better-sqlite3/**/*",
    "**/server/**/*"
  ]
}
```

### 1.2 NSIS 安装器优化

**已优化项**：
- ✅ 添加系统要求检查（Windows 10/11）
- ✅ 优化安装界面（中文界面）
- ✅ 自动创建桌面快捷方式
- ✅ 安装完成提示
- ✅ 卸载时保留用户数据

**安装器特性**：
- 非一键安装（允许选择安装目录）
- 支持管理员权限安装
- 自动创建桌面和开始菜单快捷方式
- 友好的中文界面

---

## 📦 二、打包内容说明

### 2.1 包含的运行环境

| 组件 | 说明 | 打包方式 |
|------|------|----------|
| **Electron** | 应用框架（内置 Node.js 运行时） | 自动打包 |
| **Node.js 运行时** | Electron 内置，无需单独安装 | 自动打包 |
| **后端服务** | Fastify + tsx 运行时 | 打包在 `server/` 目录 |
| **数据库** | better-sqlite3 原生模块 | 从 ASAR 解包 |
| **前端资源** | React 构建后的静态文件 | 打包在 `dist/` |
| **所有依赖** | npm dependencies 中的所有包 | 自动打包 |

### 2.2 用户无需安装的软件

✅ **Node.js** - Electron 内置  
✅ **Python** - 不需要  
✅ **Visual C++** - 不需要（原生模块已预编译）  
✅ **其他运行时** - 全部包含在安装包中

---

## 🚀 三、构建步骤

### 3.1 Windows 本地构建（推荐）

**前提条件**：
- Windows 10/11（64位）
- Node.js 18+ 已安装
- npm 已安装

**构建命令**：
```bash
# 1. 安装依赖
npm install

# 2. 编译 TypeScript
npm run compile

# 3. 构建前端
npm run build  # 或单独执行 vite build

# 4. 打包 Windows 安装包
npm run dist:win
```

**输出位置**：
- `dist/小仓库管理-1.0.0-Setup.exe`

### 3.2 GitHub Actions 构建

**步骤**：
1. 推送代码到 GitHub
2. 打开 Actions 页面
3. 选择 "Build Windows Installer"
4. 点击 "Run workflow"
5. 等待构建完成（约 5-10 分钟）
6. 下载 Artifacts 中的 `.exe` 文件

---

## 📋 四、安装包特性

### 4.1 系统要求

- ✅ **操作系统**：Windows 10（64位）或 Windows 11（64位）
- ✅ **内存**：建议 4GB 以上
- ✅ **磁盘空间**：约 200MB（安装后）
- ✅ **其他要求**：无（所有运行环境已包含）

### 4.2 安装过程

1. **双击安装包**：`小仓库管理-1.0.0-Setup.exe`
2. **系统检查**：自动检查 Windows 版本（10/11）
3. **选择安装目录**：默认 `C:\Program Files\小仓库管理`
4. **安装进度**：显示安装进度
5. **完成提示**：安装完成后显示提示信息
6. **快捷方式**：自动创建桌面和开始菜单快捷方式

### 4.3 首次启动

1. **双击桌面快捷方式**或从开始菜单启动
2. **自动启动后端服务**：应用会自动启动后端服务（约 2-5 秒）
3. **打开主窗口**：服务就绪后自动打开应用界面
4. **初始化数据库**：首次启动会自动创建数据库和表结构

---

## 🔧 五、技术细节

### 5.1 打包架构

```
安装包内容：
├── resources/
│   ├── app.asar                    # 主应用（打包）
│   ├── app.asar.unpacked/         # 解包文件
│   │   ├── better-sqlite3/        # 数据库原生模块
│   │   └── server/                # 后端服务代码
│   └── electron.asar              # Electron 框架
├── 小仓库管理.exe                  # 主程序（包含 Electron）
└── [其他 Electron 文件]
```

### 5.2 运行时流程

1. **启动主程序**：`小仓库管理.exe`
2. **Electron 初始化**：加载 Electron 框架
3. **启动后端服务**：使用内置 Node.js 运行 `server/index.ts`（通过 tsx）
4. **等待服务就绪**：轮询 `/api/health` 直到返回 200
5. **加载前端界面**：打开浏览器窗口，加载 `http://127.0.0.1:41731`

### 5.3 数据存储位置

- **数据库**：`%APPDATA%\warehouse-app\warehouse.db`
- **日志文件**：`%APPDATA%\warehouse-app\logs\app-YYYY-MM-DD.log`
- **配置文件**：`%APPDATA%\warehouse-app\`

---

## ⚠️ 六、注意事项

### 6.1 图标文件

**当前状态**：图标文件可能不存在

**影响**：
- 安装包会使用默认图标（不影响功能）
- 快捷方式会使用默认图标

**解决方案**：
1. 暂时使用默认图标（可立即构建）
2. 后续添加自定义图标文件：
   - `build/icon.ico`（256x256，ICO格式）
   - `public/icon.ico`（可选）

### 6.2 SmartScreen 警告

**现象**：Windows 10/11 可能显示"Windows 已保护你的电脑"

**原因**：未签名的应用程序

**解决方案**：
1. 点击"更多信息"
2. 点击"仍要运行"
3. 后续可以添加代码签名证书（需付费）

### 6.3 防火墙提示

**现象**：首次启动可能提示防火墙拦截

**原因**：后端服务监听本地端口 41731

**解决方案**：
1. 选择"允许访问"
2. 或手动在防火墙中添加例外

---

## 📝 七、验证清单

### 7.1 构建前检查

- [x] package.json 配置已优化
- [x] NSIS 脚本已优化
- [x] 系统要求检查已添加
- [ ] 图标文件（可选，不影响功能）
- [ ] 在 Windows 环境测试编译

### 7.2 安装后检查

- [ ] 安装过程无错误
- [ ] 桌面快捷方式已创建
- [ ] 开始菜单快捷方式已创建
- [ ] 应用能正常启动
- [ ] 后端服务自动启动
- [ ] 前端界面正常显示
- [ ] 数据库自动创建
- [ ] 所有功能正常使用

---

## 🎯 八、总结

### 8.1 已完成

✅ **配置优化**：打包配置已优化，确保所有依赖打包  
✅ **安装器优化**：NSIS 脚本已优化，添加系统检查和友好提示  
✅ **文档完善**：已创建详细的封装说明文档

### 8.2 下一步

1. **在 Windows 环境构建**：
   - 执行 `npm run dist:win`
   - 检查生成的 `.exe` 文件

2. **测试安装包**：
   - 在干净的 Windows 10/11 机器上测试
   - 验证所有功能正常

3. **可选优化**：
   - 添加自定义图标
   - 添加代码签名（可选）
   - 优化安装界面（可选）

---

## 📞 九、技术支持

如遇到问题，请检查：

1. **日志文件**：`%APPDATA%\warehouse-app\logs\app-YYYY-MM-DD.log`
2. **系统要求**：确保 Windows 10/11（64位）
3. **防火墙设置**：确保允许应用访问网络
4. **杀毒软件**：可能需要添加例外

---

*文档生成时间：2026-02-20*  
*配置版本：1.0.0*
