# æœ€ç»ˆäº¤ä»˜ - å•æœºç‰ˆä¿®å¤

> ç”Ÿæˆæ—¶é—´ï¼š2026-02-20  
> ç›®æ ‡ï¼šç¡®ä¿å•æœºç‰ˆç¨³å®šè¿è¡Œï¼Œæ— ç½‘ç»œä¾èµ–

---

## ğŸ“‹ ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨

### FIX 1: ä¸€é”®æ„å»ºå‘½ä»¤æ ¼å¼
- âœ… `backups/STEP6-ä¸€é”®æ„å»ºå‘½ä»¤-æœ€ç»ˆç‰ˆ.md` - å·²åŒ…å« A/B/C ä¸‰æ®µå‘½ä»¤
- âœ… `build-scripts/ä¸€é”®æ„å»º-Windows.bat` - å·²æ›´æ–°ï¼ˆæ¯æ¡å‘½ä»¤æ£€æŸ¥ ERRORLEVELï¼‰

### FIX 2: better-sqlite3 ç¨³å®šæ€§
- âœ… `package.json` - å·²æ·»åŠ  `predist:win` é’©å­

### FIX 3: ç«¯å£è‡ªåŠ¨åˆ‡æ¢è”åŠ¨
- âœ… `electron/main.ts` - ç«¯å£è§£æå’Œå¥åº·æ£€æŸ¥å¤šç«¯å£è½®è¯¢
- âœ… `server/index.ts` - è¾“å‡º `LISTENING:PORT=` æ ¼å¼

### FIX 4: æ•°æ®åº“/æ—¥å¿—è·¯å¾„
- âœ… `electron/main.ts` - ä½¿ç”¨ `app.getPath('userData')` è®¡ç®—è·¯å¾„
- âœ… `server/model/db.ts` - ä»ç¯å¢ƒå˜é‡è¯»å–è·¯å¾„

### FIX 5: asarUnpack é…ç½®
- âœ… `package.json` - å·²åŒ…å« `**/*.node`

---

## ğŸ”§ å…³é”®æ–‡ä»¶ diff

### 1. package.json - scripts å’Œ build é…ç½®

```diff
  "scripts": {
    "rebuild:native": "electron-rebuild -f -w better-sqlite3",
+   "predist:win": "npm run rebuild:native"
  },
  "build": {
    "asar": true,
    "asarUnpack": [
      "**/better-sqlite3/**/*",
      "**/server/dist/**/*",
+     "**/*.node"
    ]
  }
}
```

### 2. electron/main.ts - ä¸»è¿›ç¨‹å…³é”®ä¿®æ”¹

**è·¯å¾„è®¡ç®—å’Œæ—¥å¿—åˆå§‹åŒ–**ï¼š
```diff
+   const logPath = getLogPath();
+   const logStream = fs.createWriteStream(logPath, { flags: 'a' });
+   
    // è®¡ç®—ç”¨æˆ·æ•°æ®ç›®å½•ï¼ˆä½¿ç”¨ Electron app.getPathï¼‰
    const userDataDir = app.getPath('userData');
    const dbDir = path.join(userDataDir, 'warehouse-app');
    if (!fs.existsSync(dbDir)) {
      fs.mkdirSync(dbDir, { recursive: true });
    }
    
    const env = {
      ...process.env,
      NODE_ENV: 'production',
      PORT: process.env.PORT || '41731',
+     WAREHOUSE_USER_DATA: dbDir,
    };
    
    console.log(`[Electron] ç”¨æˆ·æ•°æ®ç›®å½•: ${dbDir}`);
    logStream.write(`[INFO] ç”¨æˆ·æ•°æ®ç›®å½•: ${dbDir}\n`);
```

**ç«¯å£è§£æ**ï¼š
```diff
    backendProcess.stdout?.on('data', (data: Buffer) => {
      const msg = data.toString();
      console.log('[Backend]', msg);
      logStream.write(`[STDOUT] ${msg}`);
      
+     // æ£€æµ‹ç«¯å£ä¿¡æ¯å¹¶æ›´æ–°å®é™…ç«¯å£ï¼ˆä¼˜å…ˆè§£æ LISTENING:PORT= æ ¼å¼ï¼‰
+     const portMatch = msg.match(/LISTENING:PORT=(\d+)/);
+     if (portMatch) {
+       const detectedPort = parseInt(portMatch[1], 10);
+       if (detectedPort !== actualBackendPort) {
+         actualBackendPort = detectedPort;
+         actualBackendURL = `http://127.0.0.1:${actualBackendPort}`;
+         console.log(`[Electron] æ£€æµ‹åˆ°åç«¯å®é™…ç«¯å£: ${actualBackendPort}`);
+         logStream.write(`[INFO] åç«¯å®é™…ç›‘å¬ç«¯å£: ${actualBackendPort}\n`);
+         logStream.write(`[INFO] åç«¯URL: ${actualBackendURL}\n`);
+       }
+     }
    });
```

**å¥åº·æ£€æŸ¥å¤šç«¯å£è½®è¯¢**ï¼š
```diff
    const checkHealth = async (): Promise<void> => {
      if (!backendProcess || !backendProcess.pid) {
        return;
      }
      
+     // å¦‚æœç«¯å£å·²æ›´æ–°ï¼Œä½¿ç”¨æ–°ç«¯å£ï¼›å¦åˆ™å°è¯•å¤šä¸ªç«¯å£
+     const portsToTry = actualBackendPort !== BACKEND_PORT 
+       ? [actualBackendPort] 
+       : [BACKEND_PORT, 41732, 41733, 41734, 41735, 41736, 41737, 41738, 41739, 41740];
+     
+     for (const port of portsToTry) {
+       try {
+         const testUrl = `http://127.0.0.1:${port}/api/health`;
+         const response = await fetch(testUrl);
+         if (response.ok) {
+           if (port !== actualBackendPort) {
+             actualBackendPort = port;
+             actualBackendURL = `http://127.0.0.1:${actualBackendPort}`;
+           }
+           resolve();
+           return;
+         }
+       } catch (e) {
+         continue;
+       }
+     }
+     setTimeout(checkHealth, 500);
    };
```

**ä½¿ç”¨å®é™…ç«¯å£ loadURL**ï¼š
```diff
  } else {
-   mainWindow.loadURL(BACKEND_URL);
+   mainWindow.loadURL(actualBackendURL);
+   console.log(`[Electron] åŠ è½½URL: ${actualBackendURL}`);
  }
```

**æ—¥å¿—è·¯å¾„ä¿®æ”¹**ï¼š
```diff
  function getLogPath(): string {
    const userData = app.getPath('userData');
-   const logDir = path.join(userData, 'logs');
+   const logDir = path.join(userData, 'warehouse-app', 'logs');
    if (!fs.existsSync(logDir)) {
      fs.mkdirSync(logDir, { recursive: true });
    }
    return path.join(logDir, `app-${new Date().toISOString().slice(0, 10)}.log`);
  }
```

### 3. server/index.ts - ç«¯å£è¾“å‡º

```diff
      await fastify.listen({ port, host });
      console.log(`ğŸš€ Server running at http://${host}:${port}`);
+     console.log(`LISTENING:PORT=${port}`);
```

### 4. server/model/db.ts - æ•°æ®åº“è·¯å¾„

```diff
  function getDbPath(): string {
+   // ä¼˜å…ˆä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆç”± Electron ä¸»è¿›ç¨‹é€šè¿‡ app.getPath('userData') è®¾ç½®ï¼‰
    let userDataDir: string;
    
+   if (process.env.WAREHOUSE_USER_DATA) {
+     userDataDir = process.env.WAREHOUSE_USER_DATA;
+   } else {
+     // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨å¹³å°é»˜è®¤è·¯å¾„
      userDataDir = process.platform === 'win32'
        ? path.join(os.homedir(), 'AppData', 'Roaming', 'warehouse-app')
        : path.join(os.homedir(), '.warehouse-app');
+   }
    
    return path.join(userDataDir, 'warehouse.db');
  }
```

---

## âœ… éªŒè¯æ­¥éª¤æ€»ç»“

### 1. æ„å»ºéªŒè¯
- æ‰§è¡Œæ„å»ºå‘½ä»¤ï¼ˆA/B/C ä¸‰æ®µä»»é€‰å…¶ä¸€ï¼‰
- ç¡®è®¤æ— é”™è¯¯ï¼Œç”Ÿæˆ `dist\ä»“åº“ç®¡ç†-1.0.0-Setup.exe`

### 2. å®‰è£…éªŒè¯
- åŒå‡»å®‰è£…åŒ…å®‰è£…
- ç¡®è®¤å¿«æ·æ–¹å¼åˆ›å»ºæˆåŠŸ

### 3. å¯åŠ¨éªŒè¯
- ä»æ¡Œé¢æˆ–å¼€å§‹èœå•å¯åŠ¨åº”ç”¨
- ç¡®è®¤çª—å£æ­£å¸¸æ‰“å¼€

### 4. å¥åº·æ£€æŸ¥éªŒè¯
- æ£€æŸ¥ `http://127.0.0.1:41731/api/health`ï¼ˆæˆ–å®é™…ç«¯å£ï¼‰
- é¢„æœŸè¿”å›ï¼š`{"status":"ok"}`

### 5. æ•°æ®åº“è·¯å¾„éªŒè¯
- æ£€æŸ¥ `%APPDATA%\warehouse-app\warehouse.db`
- é¢„æœŸï¼šæ–‡ä»¶å­˜åœ¨ï¼Œè·¯å¾„æ­£ç¡®

### 6. æ—¥å¿—è·¯å¾„éªŒè¯
- æ£€æŸ¥ `%APPDATA%\warehouse-app\logs\app-*.log`
- é¢„æœŸï¼šæ—¥å¿—æ–‡ä»¶å­˜åœ¨ï¼Œè®°å½•ç«¯å£å’Œè·¯å¾„ä¿¡æ¯

### 7. ç«¯å£åˆ‡æ¢éªŒè¯ï¼ˆå¯é€‰ï¼‰
- å ç”¨ç«¯å£ 41731
- å¯åŠ¨åº”ç”¨
- ç¡®è®¤çª—å£ä»èƒ½æ‰“å¼€ï¼Œä½¿ç”¨å…¶ä»–ç«¯å£

---

## ğŸ“¦ è¾“å‡ºäº§ç‰©

**å®‰è£…åŒ…ä½ç½®**ï¼š
```
dist\ä»“åº“ç®¡ç†-1.0.0-Setup.exe
```

---

**æ‰€æœ‰ä¿®å¤å·²å®Œæˆï¼Œå¯ä»¥å¼€å§‹æ„å»ºå’ŒéªŒè¯ï¼** âœ…
