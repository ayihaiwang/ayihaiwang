# å‘å¸ƒå‰æœ€ååŠ å›º - ä¿®å¤æ€»ç»“

> ä¿®å¤æ—¶é—´ï¼š2026-02-20  
> ç›®æ ‡ï¼šä¿®å¤3ä¸ªç¨³å®šæ€§/ä¸€è‡´æ€§é—®é¢˜

---

## âœ… FIX A: electron ä½ç½®ä¿®å¤

### ä¿®æ”¹æ–‡ä»¶
- `package.json` - å°† electron ä» devDependencies ç§»åˆ° dependencies

### å…³é”® diff

```diff
  "dependencies": {
    "@fastify/cors": "^9.0.1",
    "@fastify/multipart": "^8.3.1",
    "@fastify/static": "^9.0.0",
    "antd": "^5.21.0",
    "better-sqlite3": "^11.5.0",
    "dayjs": "^1.11.13",
    "echarts": "^5.5.0",
    "echarts-for-react": "^3.0.2",
+   "electron": "27.3.11",
    "exceljs": "^4.4.0",
    "fastify": "^4.29.1",
    "html2canvas": "^1.4.1",
    "jspdf": "^4.1.0",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-resizable": "^3.1.3",
    "react-router-dom": "^6.28.0",
    "tsx": "^4.21.0",
    "xlsx": "^0.18.5"
  },
  "devDependencies": {
    "@types/better-sqlite3": "^7.6.11",
    "@types/node": "^22.9.0",
    "@types/react": "^18.3.12",
    "@types/react-dom": "^18.3.1",
    "@types/react-resizable": "^3.0.8",
    "@vitejs/plugin-react": "^4.3.3",
    "concurrently": "^9.0.1",
-   "electron": "27.3.11",
    "electron-builder": "^25.1.8",
    "electron-rebuild": "^3.2.9",
    "rimraf": "^5.0.5",
    "typescript": "^5.6.3",
    "vite": "^5.4.10",
    "wait-on": "^8.0.1"
  }
```

### éªŒè¯æ­¥éª¤

1. **é‡æ–°å®‰è£…ä¾èµ–**ï¼š
   ```powershell
   Remove-Item -Recurse -Force node_modules -ErrorAction SilentlyContinue
   npm install
   ```

2. **éªŒè¯ electron åœ¨ dependencies**ï¼š
   ```powershell
   npm list electron --depth=0
   ```
   é¢„æœŸè¾“å‡ºï¼š`electron@27.3.11`

3. **éªŒè¯ electron-rebuild èƒ½è¯»å–ç‰ˆæœ¬**ï¼š
   ```powershell
   npm run rebuild:native
   ```
   é¢„æœŸï¼šæ— é”™è¯¯ï¼Œrebuild æˆåŠŸ

4. **éªŒè¯ node_modules ä¸­ electron å­˜åœ¨**ï¼š
   ```powershell
   Test-Path "node_modules\electron\package.json"
   ```
   é¢„æœŸï¼š`True`

---

## âœ… FIX B: å¥åº·æ£€æŸ¥ fetch è¶…æ—¶ä¸å¼‚å¸¸å¤„ç†

### ä¿®æ”¹æ–‡ä»¶
- `electron/main.ts` - å¥åº·æ£€æŸ¥å‡½æ•°æ·»åŠ è¶…æ—¶å’Œå¼‚å¸¸å¤„ç†

### å…³é”® diff

```diff
      for (const port of portsToTry) {
        try {
          const testUrl = `http://127.0.0.1:${port}/api/health`;
          
+         // ä½¿ç”¨ AbortController è®¾ç½®è¶…æ—¶ï¼ˆ1500msï¼‰
+         const controller = new AbortController();
+         const timeout = setTimeout(() => controller.abort(), 1500);
+         
-         const response = await fetch(testUrl);
+         const response = await fetch(testUrl, { 
+           signal: controller.signal 
+         });
+         
+         clearTimeout(timeout);
+         
          if (response.ok) {
            // æ‰¾åˆ°å¯ç”¨ç«¯å£ï¼Œæ›´æ–°å…¨å±€å˜é‡
            if (port !== actualBackendPort) {
              actualBackendPort = port;
              actualBackendURL = `http://127.0.0.1:${actualBackendPort}`;
              console.log(`[Electron] å¥åº·æ£€æŸ¥å‘ç°åç«¯ç«¯å£: ${actualBackendPort}`);
              logStream.write(`[INFO] å¥åº·æ£€æŸ¥å‘ç°åç«¯ç«¯å£: ${actualBackendPort}\n`);
              logStream.write(`[INFO] åç«¯URL: ${actualBackendURL}\n`);
            }
            console.log(`[Electron] åç«¯æœåŠ¡å·²å°±ç»ª: ${actualBackendURL}`);
            logStream.write(`[INFO] å¥åº·æ£€æŸ¥é€šè¿‡: ${actualBackendURL}/api/health\n`);
            logStream.end();
            if (timeoutId) clearTimeout(timeoutId);
            resolve();
            return;
          }
        } catch (e: any) {
+         // è¶…æ—¶æˆ–å…¶ä»–é”™è¯¯ï¼Œç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªç«¯å£
+         if (e.name === 'AbortError') {
+           // è¶…æ—¶ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªç«¯å£
+           continue;
+         }
          // å…¶ä»–é”™è¯¯ï¼ˆå¦‚è¿æ¥æ‹’ç»ï¼‰ï¼Œä¹Ÿç»§ç»­ä¸‹ä¸€ä¸ªç«¯å£
          continue;
        }
      }
```

### éªŒè¯æ­¥éª¤

1. **å ç”¨ç«¯å£ 41731**ï¼š
   ```powershell
   $listener = [System.Net.Sockets.TcpListener]::new([System.Net.IPAddress]::Any, 41731)
   $listener.Start()
   ```

2. **å ç”¨ç«¯å£ 41732-41735**ï¼ˆæ¨¡æ‹Ÿä¸å¯è¾¾ç«¯å£ï¼‰ï¼š
   ```powershell
   $listeners = @()
   for ($port = 41732; $port -le 41735; $port++) {
       $listener = [System.Net.Sockets.TcpListener]::new([System.Net.IPAddress]::Any, $port)
       $listener.Start()
       $listeners += $listener
   }
   ```

3. **å¯åŠ¨åº”ç”¨**ï¼šåŒå‡»æ¡Œé¢å›¾æ ‡å¯åŠ¨åº”ç”¨

4. **éªŒè¯åº”ç”¨å¯åŠ¨**ï¼š
   - åº”ç”¨çª—å£åº”æ­£å¸¸æ‰“å¼€
   - ä¸åº”å¡æ­»æˆ–é•¿æ—¶é—´æ— å“åº”
   - åº”åœ¨ 15 ç§’å†…å®Œæˆå¯åŠ¨

5. **æ£€æŸ¥æ—¥å¿—**ï¼š
   ```powershell
   Get-Content "$env:APPDATA\warehouse-app\logs\app-*.log" -Tail 30
   ```
   é¢„æœŸï¼šæ—¥å¿—æ˜¾ç¤ºå¥åº·æ£€æŸ¥å°è¯•å¤šä¸ªç«¯å£ï¼Œæœ€ç»ˆæ‰¾åˆ°å¯ç”¨ç«¯å£ï¼ˆå¦‚ 41736ï¼‰

6. **éªŒè¯å¥åº·ç«¯ç‚¹**ï¼š
   ```powershell
   Invoke-WebRequest -Uri "http://127.0.0.1:41736/api/health" -UseBasicParsing
   ```
   é¢„æœŸï¼šè¿”å› `{"status":"ok"}`

7. **é‡Šæ”¾ç«¯å£**ï¼š
   ```powershell
   $listener.Stop()
   foreach ($l in $listeners) { $l.Stop() }
   ```

---

## âœ… FIX C: æ•°æ®è·¯å¾„ç»Ÿä¸€æ”¹ä¸º app.getPath('appData')

### ä¿®æ”¹æ–‡ä»¶
- `electron/main.ts` - è·¯å¾„è®¡ç®—å‡½æ•°ä¿®æ”¹

### å…³é”® diff

**æ—¥å¿—è·¯å¾„å‡½æ•°**ï¼š
```diff
- // æ—¥å¿—æ–‡ä»¶è·¯å¾„ï¼ˆä½¿ç”¨ app.getPath('userData')ï¼‰
  function getLogPath(): string {
-   const userData = app.getPath('userData');
-   const logDir = path.join(userData, 'warehouse-app', 'logs');
+   const baseDir = path.join(app.getPath('appData'), 'warehouse-app');
+   const logDir = path.join(baseDir, 'logs');
    if (!fs.existsSync(logDir)) {
      fs.mkdirSync(logDir, { recursive: true });
    }
    return path.join(logDir, `app-${new Date().toISOString().slice(0, 10)}.log`);
  }
```

**ç”¨æˆ·æ•°æ®ç›®å½•è®¡ç®—**ï¼š
```diff
-   // è®¡ç®—ç”¨æˆ·æ•°æ®ç›®å½•ï¼ˆä½¿ç”¨ Electron app.getPathï¼‰
-   const userDataDir = app.getPath('userData');
-   const dbDir = path.join(userDataDir, 'warehouse-app');
-   if (!fs.existsSync(dbDir)) {
-     fs.mkdirSync(dbDir, { recursive: true });
-   }
+   // è®¡ç®—ç”¨æˆ·æ•°æ®ç›®å½•ï¼ˆä½¿ç”¨ Electron app.getPath('appData')ï¼‰
+   const baseDir = path.join(app.getPath('appData'), 'warehouse-app');
+   if (!fs.existsSync(baseDir)) {
+     fs.mkdirSync(baseDir, { recursive: true });
+   }
    
    const env = {
      ...process.env,
      NODE_ENV: 'production',
      PORT: process.env.PORT || '41731',
-     WAREHOUSE_USER_DATA: dbDir,
+     WAREHOUSE_USER_DATA: baseDir,
    };
    
    const logPath = getLogPath();
    const logStream = fs.createWriteStream(logPath, { flags: 'a' });
    
-   console.log(`[Electron] ç”¨æˆ·æ•°æ®ç›®å½•: ${dbDir}`);
-   logStream.write(`[INFO] ç”¨æˆ·æ•°æ®ç›®å½•: ${dbDir}\n`);
+   console.log(`[Electron] ç”¨æˆ·æ•°æ®ç›®å½•: ${baseDir}`);
+   logStream.write(`[INFO] ç”¨æˆ·æ•°æ®ç›®å½•: ${baseDir}\n`);
```

### è·¯å¾„è¯´æ˜

**ä¿®æ”¹å‰**ï¼ˆä½¿ç”¨ userDataï¼‰ï¼š
- Windows: `C:\Users\<ç”¨æˆ·å>\AppData\Roaming\ä»“åº“ç®¡ç†\warehouse-app\`
- macOS: `~/Library/Application Support/ä»“åº“ç®¡ç†/warehouse-app/`
- Linux: `~/.config/ä»“åº“ç®¡ç†/warehouse-app/`

**ä¿®æ”¹å**ï¼ˆä½¿ç”¨ appDataï¼‰ï¼š
- Windows: `C:\Users\<ç”¨æˆ·å>\AppData\Roaming\warehouse-app\`
- macOS: `~/Library/Application Support/warehouse-app/`
- Linux: `~/.config/warehouse-app/`

### éªŒè¯æ­¥éª¤

1. **æ¸…ç†æ—§æ•°æ®**ï¼ˆå¯é€‰ï¼‰ï¼š
   ```powershell
   # å¦‚æœä¹‹å‰æœ‰æ—§ç‰ˆæœ¬å®‰è£…ï¼Œæ¸…ç†æ—§æ•°æ®ç›®å½•
   Remove-Item -Recurse -Force "$env:APPDATA\ä»“åº“ç®¡ç†" -ErrorAction SilentlyContinue
   ```

2. **å¯åŠ¨åº”ç”¨**ï¼šåŒå‡»æ¡Œé¢å›¾æ ‡å¯åŠ¨åº”ç”¨

3. **éªŒè¯æ•°æ®åº“è·¯å¾„**ï¼š
   ```powershell
   $dbPath = "$env:APPDATA\warehouse-app\warehouse.db"
   Test-Path $dbPath
   Get-Item $dbPath | Select-Object FullName
   ```
   é¢„æœŸï¼š`C:\Users\<ç”¨æˆ·å>\AppData\Roaming\warehouse-app\warehouse.db`

4. **éªŒè¯æ—¥å¿—è·¯å¾„**ï¼š
   ```powershell
   $logDir = "$env:APPDATA\warehouse-app\logs"
   Test-Path $logDir
   Get-ChildItem $logDir | Select-Object FullName
   ```
   é¢„æœŸï¼š`C:\Users\<ç”¨æˆ·å>\AppData\Roaming\warehouse-app\logs\app-YYYY-MM-DD.log`

5. **æ£€æŸ¥æ—¥å¿—å†…å®¹**ï¼š
   ```powershell
   Get-Content "$env:APPDATA\warehouse-app\logs\app-*.log" | Select-String "ç”¨æˆ·æ•°æ®ç›®å½•"
   ```
   é¢„æœŸï¼šæ—¥å¿—ä¸­æ˜¾ç¤º `[INFO] ç”¨æˆ·æ•°æ®ç›®å½•: C:\Users\<ç”¨æˆ·å>\AppData\Roaming\warehouse-app`

6. **ç¡®è®¤è·¯å¾„ç»“æ„**ï¼š
   ```powershell
   Get-ChildItem "$env:APPDATA\warehouse-app" -Recurse | Select-Object FullName
   ```
   é¢„æœŸç»“æ„ï¼š
   ```
   C:\Users\<ç”¨æˆ·å>\AppData\Roaming\warehouse-app\
     â”œâ”€â”€ warehouse.db
     â””â”€â”€ logs\
         â””â”€â”€ app-YYYY-MM-DD.log
   ```

---

## ğŸ“‹ æœ€ç»ˆéªŒè¯æµç¨‹

### 1. æ„å»ºéªŒè¯

```powershell
cd "D:\ä»“åº“ç®¡ç†\warehouse-app"

# æ¸…ç†å¹¶é‡æ–°å®‰è£…
Remove-Item -Recurse -Force node_modules -ErrorAction SilentlyContinue
npm install

# éªŒè¯ electron åœ¨ dependencies
npm list electron --depth=0

# æ‰§è¡Œæ„å»º
npm run server:build
npm run rebuild:native
npm run compile
npm run build
npm run dist:win
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… electron åœ¨ dependencies ä¸­
- âœ… rebuild:native æˆåŠŸ
- âœ… æ„å»ºæˆåŠŸï¼Œç”Ÿæˆ `dist\ä»“åº“ç®¡ç†-1.0.0-Setup.exe`

### 2. å®‰è£…éªŒè¯

1. **åŒå‡»å®‰è£…åŒ…**ï¼š`dist\ä»“åº“ç®¡ç†-1.0.0-Setup.exe`
2. **é€‰æ‹©å®‰è£…ç›®å½•**ï¼ˆå¯é€‰ï¼‰
3. **ç­‰å¾…å®‰è£…å®Œæˆ**

**é¢„æœŸç»“æœ**ï¼š
- âœ… å®‰è£…æˆåŠŸ
- âœ… å¿«æ·æ–¹å¼åˆ›å»ºæˆåŠŸ

### 3. å¯åŠ¨éªŒè¯

1. **ä»æ¡Œé¢æˆ–å¼€å§‹èœå•å¯åŠ¨åº”ç”¨**
2. **ç­‰å¾…çª—å£æ‰“å¼€**ï¼ˆ3-5 ç§’ï¼‰

**é¢„æœŸç»“æœ**ï¼š
- âœ… çª—å£æ­£å¸¸æ‰“å¼€
- âœ… æ— é”™è¯¯å¼¹çª—
- âœ… ç•Œé¢æ­£å¸¸æ˜¾ç¤º

### 4. æ•°æ®åº“è·¯å¾„éªŒè¯

```powershell
$dbPath = "$env:APPDATA\warehouse-app\warehouse.db"
Test-Path $dbPath
Get-Item $dbPath | Select-Object FullName, Length
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ•°æ®åº“æ–‡ä»¶åœ¨ï¼š`C:\Users\<ç”¨æˆ·å>\AppData\Roaming\warehouse-app\warehouse.db`
- âœ… æ–‡ä»¶å­˜åœ¨ä¸”å¤§å° > 0

### 5. å¥åº·ç«¯ç‚¹éªŒè¯

```powershell
Start-Sleep -Seconds 3
Invoke-WebRequest -Uri "http://127.0.0.1:41731/api/health" -UseBasicParsing
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… è¿”å›ï¼š`{"status":"ok"}`

### 6. ç«¯å£å ç”¨åœºæ™¯éªŒè¯

```powershell
# å ç”¨ç«¯å£ 41731-41735
$listeners = @()
for ($port = 41731; $port -le 41735; $port++) {
    $listener = [System.Net.Sockets.TcpListener]::new([System.Net.IPAddress]::Any, $port)
    $listener.Start()
    $listeners += $listener
}

# å¯åŠ¨åº”ç”¨
# æ£€æŸ¥çª—å£æ˜¯å¦æ­£å¸¸æ‰“å¼€

# éªŒè¯æ–°ç«¯å£
for ($port = 41736; $port -le 41740; $port++) {
    $testUrl = "http://127.0.0.1:$port/api/health"
    $testResponse = Invoke-WebRequest -Uri $testUrl -UseBasicParsing -ErrorAction SilentlyContinue
    if ($testResponse) {
        Write-Host "âœ… åç«¯è¿è¡Œåœ¨ç«¯å£ $port"
        break
    }
}

# é‡Šæ”¾ç«¯å£
foreach ($l in $listeners) { $l.Stop() }
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… åº”ç”¨çª—å£æ­£å¸¸æ‰“å¼€
- âœ… åç«¯è¿è¡Œåœ¨å…¶ä»–ç«¯å£ï¼ˆ41736-41740ï¼‰
- âœ… å¥åº·æ£€æŸ¥é€šè¿‡

---

## âœ… ä¿®å¤å®Œæˆæ¸…å•

- [x] FIX A: electron ç§»åˆ° dependencies
- [x] FIX B: å¥åº·æ£€æŸ¥ fetch è¶…æ—¶ä¸å¼‚å¸¸å¤„ç†
- [x] FIX C: æ•°æ®è·¯å¾„ç»Ÿä¸€æ”¹ä¸º app.getPath('appData')

---

**æ‰€æœ‰åŠ å›ºä¿®å¤å·²å®Œæˆï¼å¯ä»¥å¼€å§‹æœ€ç»ˆæ„å»ºå’Œå‘å¸ƒï¼** âœ…
