# æœ€ç»ˆäº¤ä»˜ - Windows 10/11 å‚»ç“œå¼ä¸€é”®å®‰è£…åŒ…

> ç”Ÿæˆæ—¶é—´ï¼š2026-02-20  
> ç›®æ ‡ï¼šç”ŸæˆçœŸæ­£"å‚»ç“œå¼"å®‰è£…åŒ…ï¼Œç”¨æˆ·åŒå‡»å³ç”¨

---

## A. electron-builder è¾“å‡ºé…ç½®ç¡®è®¤ âœ…

### 1. NSIS é…ç½®ï¼ˆå·²ä¿®æ”¹ä¸ºä¸€é”®å®‰è£…æ¨¡å¼ï¼‰

```json
{
  "nsis": {
    "oneClick": true,                          // âœ… ä¸€é”®å®‰è£…ï¼ˆå·²ä¿®æ”¹ï¼‰
    "allowToChangeInstallationDirectory": false, // âœ… ä¸å…è®¸é€‰æ‹©ç›®å½•ï¼ˆå·²ä¿®æ”¹ï¼‰
    "perMachine": false,                        // âœ… å®‰è£…åˆ°ç”¨æˆ·ç›®å½•ï¼ˆæ–°å¢ï¼‰
    "allowElevation": true,                    // âœ… å…è®¸æå‡æƒé™
    "createDesktopShortcut": "always",         // âœ… åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
    "createStartMenuShortcut": true,            // âœ… åˆ›å»ºå¼€å§‹èœå•å¿«æ·æ–¹å¼
    "shortcutName": "ä»“åº“ç®¡ç†",                 // âœ… å¿«æ·æ–¹å¼åç§°
    "include": "build/installer.nsh",          // âœ… è‡ªå®šä¹‰å®‰è£…è„šæœ¬
    "installerLanguages": ["zh_CN"],           // âœ… ä¸­æ–‡ç•Œé¢
    "language": "2052",                         // âœ… ä¸­æ–‡è¯­è¨€ä»£ç 
    "runAfterFinish": false,                    // âœ… å®‰è£…åä¸è‡ªåŠ¨è¿è¡Œ
    "artifactName": "${productName}-${version}-Setup.${ext}"
  }
}
```

**å…³é”®ä¿®æ”¹ diff**ï¼š
```diff
- "oneClick": false,
+ "oneClick": true,
- "allowToChangeInstallationDirectory": true,
+ "allowToChangeInstallationDirectory": false,
+ "perMachine": false,
```

### 2. ASAR é…ç½®ï¼ˆå·²ç¡®è®¤ï¼‰

```json
{
  "asar": true,
  "asarUnpack": [
    "**/better-sqlite3/**/*",                 // âœ… better-sqlite3 è§£åŒ…
    "**/server/dist/**/*",                     // âœ… åç«¯ç¼–è¯‘äº§ç‰©è§£åŒ…
    "**/*.node"                                // âœ… æ‰€æœ‰ native æ¨¡å—è§£åŒ…
  ]
}
```

### 3. predist:win é’©å­ï¼ˆå·²ç¡®è®¤ï¼‰

```json
{
  "scripts": {
    "rebuild:native": "electron-rebuild -f -w better-sqlite3",
    "predist:win": "npm run rebuild:native"    // âœ… æ‰“åŒ…å‰è‡ªåŠ¨ rebuild
  }
}
```

---

## B. ä¸€é”®æ„å»ºå‘½ä»¤ï¼ˆPowerShell - å¯å¤åˆ¶æ‰§è¡Œï¼‰

```powershell
cd "D:\ä»“åº“ç®¡ç†\warehouse-app"
Remove-Item -Recurse -Force node_modules, server\dist, dist-electron, dist -ErrorAction SilentlyContinue
npm install
npm run server:build
npm run compile
npm run build
npm run dist:win
```

**æˆ–ä½¿ç”¨æ‰¹å¤„ç†è„šæœ¬**ï¼š
```batch
build-scripts\ä¸€é”®æ„å»ºå¹¶ç”Ÿæˆå®‰è£…åŒ….bat
```

**æˆ–ä½¿ç”¨ PowerShell è„šæœ¬**ï¼š
```powershell
powershell -ExecutionPolicy Bypass -File "build-scripts\ä¸€é”®æ„å»ºå¹¶ç”Ÿæˆå®‰è£…åŒ….ps1"
```

---

## C. å®‰è£…åŒ…å¤åˆ¶åˆ°æŒ‡å®šç›®å½•

æ„å»ºå®Œæˆåï¼Œå®‰è£…åŒ…ä¼šè‡ªåŠ¨å¤åˆ¶åˆ°ï¼š
```
D:\ä»“åº“ç®¡ç†\warehouse-app\build-scripts\ä»“åº“ç®¡ç†-1.0.0-Setup.exe
```

**æ‰‹åŠ¨å¤åˆ¶å‘½ä»¤**ï¼ˆå¦‚æœè„šæœ¬æœªè‡ªåŠ¨å¤åˆ¶ï¼‰ï¼š
```powershell
Copy-Item -Path "dist\ä»“åº“ç®¡ç†-1.0.0-Setup.exe" -Destination "build-scripts\ä»“åº“ç®¡ç†-1.0.0-Setup.exe" -Force
```

---

## D. æœ€ç»ˆéªŒè¯æµç¨‹

### 1. å®‰è£…éªŒè¯

1. **åŒå‡»å®‰è£…åŒ…**ï¼š`build-scripts\ä»“åº“ç®¡ç†-1.0.0-Setup.exe`
2. **è‡ªåŠ¨å®‰è£…**ï¼š
   - æ— éœ€é€‰æ‹©å®‰è£…ç›®å½•ï¼ˆoneClick: trueï¼‰
   - è‡ªåŠ¨å®‰è£…åˆ°é»˜è®¤ä½ç½®
   - è‡ªåŠ¨åˆ›å»ºæ¡Œé¢å’Œå¼€å§‹èœå•å¿«æ·æ–¹å¼
3. **å®‰è£…å®Œæˆ**ï¼šæ˜¾ç¤ºå®Œæˆæç¤º

### 2. å¯åŠ¨éªŒè¯

1. **ä»æ¡Œé¢æˆ–å¼€å§‹èœå•å¯åŠ¨åº”ç”¨**
2. **ç­‰å¾…çª—å£æ‰“å¼€**ï¼ˆ3-5 ç§’ï¼‰

**é¢„æœŸç»“æœ**ï¼š
- âœ… çª—å£æ­£å¸¸æ‰“å¼€
- âœ… æ— é”™è¯¯å¼¹çª—
- âœ… ç•Œé¢æ­£å¸¸æ˜¾ç¤º

### 3. å¥åº·æ£€æŸ¥éªŒè¯

```powershell
Start-Sleep -Seconds 3
Invoke-WebRequest -Uri "http://127.0.0.1:41731/api/health" -UseBasicParsing
```

**é¢„æœŸå“åº”**ï¼š`{"status":"ok"}`

**å¦‚æœç«¯å£è¢«å ç”¨ï¼Œæ£€æŸ¥å…¶ä»–ç«¯å£**ï¼š
```powershell
for ($port = 41732; $port -le 41740; $port++) {
    $testUrl = "http://127.0.0.1:$port/api/health"
    $testResponse = Invoke-WebRequest -Uri $testUrl -UseBasicParsing -ErrorAction SilentlyContinue
    if ($testResponse) {
        Write-Host "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ï¼ˆç«¯å£ $portï¼‰: $($testResponse.Content)"
        break
    }
}
```

### 4. æ•°æ®åº“è·¯å¾„éªŒè¯

```powershell
$dbPath = "$env:APPDATA\warehouse-app\warehouse.db"
Test-Path $dbPath
Get-Item $dbPath | Select-Object FullName, Length
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ•°æ®åº“æ–‡ä»¶åœ¨ï¼š`C:\Users\<ç”¨æˆ·å>\AppData\Roaming\warehouse-app\warehouse.db`
- âœ… æ–‡ä»¶å­˜åœ¨ä¸”å¤§å° > 0

### 5. æ—¥å¿—è·¯å¾„éªŒè¯

```powershell
$logDir = "$env:APPDATA\warehouse-app\logs"
Get-ChildItem $logDir | Sort-Object LastWriteTime -Descending | Select-Object -First 1
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ—¥å¿—æ–‡ä»¶åœ¨ï¼š`C:\Users\<ç”¨æˆ·å>\AppData\Roaming\warehouse-app\logs\app-YYYY-MM-DD.log`

### 6. åç«¯å´©æºƒæç¤ºéªŒè¯ï¼ˆå¯é€‰ï¼‰

```powershell
# æŸ¥æ‰¾åç«¯è¿›ç¨‹å¹¶ç»ˆæ­¢
$nodeProcesses = Get-Process | Where-Object {$_.ProcessName -eq "node"}
$nodeProcesses | Select-Object Id, ProcessName

# ç»ˆæ­¢è¿›ç¨‹ï¼ˆæ›¿æ¢ <PID> ä¸ºå®é™… PIDï¼‰
Stop-Process -Id <PID> -Force
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… å¼¹å‡ºé”™è¯¯å¯¹è¯æ¡†
- âœ… æ˜¾ç¤ºé€€å‡ºç å’Œæ—¥å¿—è·¯å¾„

---

## E. æœ€ç»ˆäº¤ä»˜ä¿¡æ¯

### 1. å®‰è£…åŒ…å®Œæ•´è·¯å¾„

```
D:\ä»“åº“ç®¡ç†\warehouse-app\build-scripts\ä»“åº“ç®¡ç†-1.0.0-Setup.exe
```

### 2. æ–‡ä»¶å¤§å°

æ„å»ºå®Œæˆåæ£€æŸ¥ï¼š
```powershell
Get-Item "D:\ä»“åº“ç®¡ç†\warehouse-app\build-scripts\ä»“åº“ç®¡ç†-1.0.0-Setup.exe" | Select-Object Length
```

**é¢„æœŸå¤§å°**ï¼š100-200 MBï¼ˆå–å†³äºä¾èµ–å¤§å°ï¼‰

### 3. build é…ç½®å…³é”®å­—æ®µ

**NSIS é…ç½®**ï¼š
- `oneClick: true` âœ…
- `allowToChangeInstallationDirectory: false` âœ…
- `perMachine: false` âœ…
- `createDesktopShortcut: "always"` âœ…
- `createStartMenuShortcut: true` âœ…

**ASAR é…ç½®**ï¼š
- `asar: true` âœ…
- `asarUnpack: ["**/better-sqlite3/**/*", "**/server/dist/**/*", "**/*.node"]` âœ…

**é’©å­é…ç½®**ï¼š
- `predist:win: "npm run rebuild:native"` âœ…

### 4. æ„å»ºæ—¥å¿—å…³é”®ç‰‡æ®µ

æ‰§è¡Œ `npm run dist:win` æ—¶ï¼Œåº”çœ‹åˆ°ï¼š

```
> warehouse-app@1.0.0 predist:win
> npm run rebuild:native

> warehouse-app@1.0.0 rebuild:native
> electron-rebuild -f -w better-sqlite3

...
```

ç„¶åç»§ç»­æ‰§è¡Œï¼š
```
> warehouse-app@1.0.0 dist:win
> npm run compile && npm run server:build && vite build && electron-builder --win --publish never
```

---

## ğŸ“‹ é…ç½®ä¿®æ”¹ diff

### package.json - nsis é…ç½®ä¿®æ”¹

```diff
    "nsis": {
-     "oneClick": false,
+     "oneClick": true,
-     "allowToChangeInstallationDirectory": true,
+     "allowToChangeInstallationDirectory": false,
+     "perMachine": false,
      "allowElevation": true,
      "createDesktopShortcut": "always",
      "createStartMenuShortcut": true,
      "shortcutName": "ä»“åº“ç®¡ç†",
      "include": "build/installer.nsh",
      "installerLanguages": ["zh_CN"],
      "language": "2052",
      "warningsAsErrors": false,
      "runAfterFinish": false,
      "menuCategory": false,
      "artifactName": "${productName}-${version}-Setup.${ext}"
    }
```

---

## ğŸš€ æ‰§è¡Œæ„å»º

**æ¨èæ–¹å¼**ï¼šä½¿ç”¨ PowerShell è„šæœ¬ï¼ˆè‡ªåŠ¨å¤åˆ¶åˆ° build-scriptsï¼‰

```powershell
cd "D:\ä»“åº“ç®¡ç†\warehouse-app"
powershell -ExecutionPolicy Bypass -File "build-scripts\ä¸€é”®æ„å»ºå¹¶ç”Ÿæˆå®‰è£…åŒ….ps1"
```

**æˆ–æ‰‹åŠ¨æ‰§è¡Œ**ï¼š

```powershell
cd "D:\ä»“åº“ç®¡ç†\warehouse-app"
Remove-Item -Recurse -Force node_modules, server\dist, dist-electron, dist -ErrorAction SilentlyContinue
npm install
npm run server:build
npm run compile
npm run build
npm run dist:win

# å¤åˆ¶åˆ° build-scripts
Copy-Item -Path "dist\ä»“åº“ç®¡ç†-1.0.0-Setup.exe" -Destination "build-scripts\ä»“åº“ç®¡ç†-1.0.0-Setup.exe" -Force
```

---

**é…ç½®å·²ä¿®æ”¹å®Œæˆï¼Œå¯ä»¥å¼€å§‹æ„å»ºï¼** âœ…
