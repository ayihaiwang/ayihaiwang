# æœ€ç»ˆäº¤ä»˜ - Windows 10/11 å‚»ç“œå¼ä¸€é”®å®‰è£…åŒ…

> ç”Ÿæˆæ—¶é—´ï¼š2026-02-20

---

## A. electron-builder è¾“å‡ºé…ç½®ç¡®è®¤ âœ…

### 1. NSIS é…ç½®ï¼ˆå·²ä¿®æ”¹ä¸ºä¸€é”®å®‰è£…æ¨¡å¼ï¼‰

**å½“å‰é…ç½®**ï¼š
```json
{
  "nsis": {
    "oneClick": true,                          // âœ… ä¸€é”®å®‰è£…
    "allowToChangeInstallationDirectory": false, // âœ… ä¸å…è®¸é€‰æ‹©ç›®å½•
    "perMachine": false,                        // âœ… å®‰è£…åˆ°ç”¨æˆ·ç›®å½•ï¼ˆä¸éœ€è¦ç®¡ç†å‘˜ï¼‰
    "allowElevation": true,                    // âœ… å…è®¸æå‡æƒé™ï¼ˆå¦‚æœéœ€è¦ï¼‰
    "createDesktopShortcut": "always",         // âœ… åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
    "createStartMenuShortcut": true,            // âœ… åˆ›å»ºå¼€å§‹èœå•å¿«æ·æ–¹å¼
    "shortcutName": "ä»“åº“ç®¡ç†",                 // âœ… å¿«æ·æ–¹å¼åç§°
    "include": "build/installer.nsh",          // âœ… è‡ªå®šä¹‰å®‰è£…è„šæœ¬
    "installerLanguages": ["zh_CN"],           // âœ… ä¸­æ–‡ç•Œé¢
    "language": "2052",                         // âœ… ä¸­æ–‡è¯­è¨€ä»£ç 
    "runAfterFinish": false,                    // âœ… å®‰è£…åä¸è‡ªåŠ¨è¿è¡Œ
    "artifactName": "${productName}-${version}-Setup.${ext}"
  }
}
```

**é…ç½®ä¿®æ”¹ diff**ï¼š
```diff
    "nsis": {
-     "oneClick": false,
+     "oneClick": true,
-     "allowToChangeInstallationDirectory": true,
+     "allowToChangeInstallationDirectory": false,
+     "perMachine": false,
      "allowElevation": true,
      "createDesktopShortcut": "always",
      "createStartMenuShortcut": true,
      ...
    }
```

### 2. ASAR é…ç½®ï¼ˆå·²ç¡®è®¤ï¼‰

```json
{
  "asar": true,
  "asarUnpack": [
    "**/better-sqlite3/**/*",                 // âœ… better-sqlite3 è§£åŒ…
    "**/server/dist/**/*",                     // âœ… åç«¯ç¼–è¯‘äº§ç‰©è§£åŒ…
    "**/*.node"                                // âœ… æ‰€æœ‰ native æ¨¡å—è§£åŒ…
  ]
}
```

### 3. Windows Target é…ç½®ï¼ˆå·²ç¡®è®¤ï¼‰

```json
{
  "win": {
    "target": [
      {
        "target": "nsis",                      // âœ… NSIS å®‰è£…åŒ…
        "arch": ["x64"]                         // âœ… x64 æ¶æ„
      }
    ],
    "icon": "public/icon.ico",
    "requestedExecutionLevel": "asInvoker",
    "publisherName": "ä»“åº“ç®¡ç†ç³»ç»Ÿ"
  }
}
```

### 4. predist:win é’©å­ï¼ˆå·²ç¡®è®¤ï¼‰

```json
{
  "scripts": {
    "rebuild:native": "electron-rebuild -f -w better-sqlite3",
    "predist:win": "npm run rebuild:native"    // âœ… æ‰“åŒ…å‰è‡ªåŠ¨ rebuild
  }
}
```

---

## B. ä¸€é”®æ„å»ºå‘½ä»¤ï¼ˆPowerShell - å¯å¤åˆ¶æ‰§è¡Œï¼‰

### æ–¹å¼ 1: ä½¿ç”¨æ‰¹å¤„ç†è„šæœ¬ï¼ˆæ¨èï¼‰

```batch
build-scripts\æ‰§è¡Œæ„å»º-ç”Ÿæˆå®‰è£…åŒ….bat
```

### æ–¹å¼ 2: PowerShell é€æ¡æ‰§è¡Œ

```powershell
cd "D:\ä»“åº“ç®¡ç†\warehouse-app"
Remove-Item -Recurse -Force node_modules, server\dist, dist-electron, dist -ErrorAction SilentlyContinue
npm install
npm run server:build
npm run compile
npm run build
npm run dist:win

# å¤åˆ¶åˆ° build-scripts
Copy-Item -Path "dist\ä»“åº“ç®¡ç†-1.0.0-Setup.exe" -Destination "build-scripts\ä»“åº“ç®¡ç†-1.0.0-Setup.exe" -Force
```

### æ–¹å¼ 3: PowerShell å•è¡Œ

```powershell
cd "D:\ä»“åº“ç®¡ç†\warehouse-app"; Remove-Item -Recurse -Force node_modules, server\dist, dist-electron, dist -ErrorAction SilentlyContinue; npm install; npm run server:build; npm run compile; npm run build; npm run dist:win; Copy-Item -Path "dist\ä»“åº“ç®¡ç†-1.0.0-Setup.exe" -Destination "build-scripts\ä»“åº“ç®¡ç†-1.0.0-Setup.exe" -Force
```

---

## C. å®‰è£…åŒ…è¾“å‡ºä½ç½®

**æ„å»ºè¾“å‡º**ï¼š`dist\ä»“åº“ç®¡ç†-1.0.0-Setup.exe`  
**æœ€ç»ˆä½ç½®**ï¼š`D:\ä»“åº“ç®¡ç†\warehouse-app\build-scripts\ä»“åº“ç®¡ç†-1.0.0-Setup.exe`

---

## D. æ„å»ºæ—¥å¿—å…³é”®ç‰‡æ®µï¼ˆéªŒè¯ predist:win æ‰§è¡Œï¼‰

æ‰§è¡Œ `npm run dist:win` æ—¶ï¼Œåº”çœ‹åˆ°ä»¥ä¸‹è¾“å‡ºï¼š

```
> warehouse-app@1.0.0 predist:win
> npm run rebuild:native

> warehouse-app@1.0.0 rebuild:native
> electron-rebuild -f -w better-sqlite3

Rebuilding native production dependencies for win32:x64...
...
```

ç„¶åç»§ç»­ï¼š
```
> warehouse-app@1.0.0 dist:win
> npm run compile && npm run server:build && vite build && electron-builder --win --publish never

  â€¢ electron-builder  version=25.1.8
  â€¢ loaded configuration  file=package.json
  â€¢ packaging       platform=win32 arch=x64 electron=27.3.11
  ...
  â€¢ building        target=NSIS file=dist\ä»“åº“ç®¡ç†-1.0.0-Setup.exe
  ...
```

---

## E. æœ€ç»ˆéªŒè¯æµç¨‹

### 1. å®‰è£…éªŒè¯

1. **åŒå‡»å®‰è£…åŒ…**ï¼š`build-scripts\ä»“åº“ç®¡ç†-1.0.0-Setup.exe`
2. **è‡ªåŠ¨å®‰è£…**ï¼š
   - âœ… æ— éœ€é€‰æ‹©å®‰è£…ç›®å½•ï¼ˆoneClick: trueï¼‰
   - âœ… è‡ªåŠ¨å®‰è£…åˆ°é»˜è®¤ä½ç½®ï¼š`C:\Users\<ç”¨æˆ·å>\AppData\Local\ä»“åº“ç®¡ç†`
   - âœ… è‡ªåŠ¨åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
   - âœ… è‡ªåŠ¨åˆ›å»ºå¼€å§‹èœå•å¿«æ·æ–¹å¼
   - âœ… æ˜¾ç¤ºå®‰è£…å®Œæˆæç¤º

### 2. å¯åŠ¨éªŒè¯

1. **ä»æ¡Œé¢æˆ–å¼€å§‹èœå•å¯åŠ¨åº”ç”¨**
2. **ç­‰å¾…çª—å£æ‰“å¼€**ï¼ˆ3-5 ç§’ï¼‰

**é¢„æœŸç»“æœ**ï¼š
- âœ… çª—å£æ­£å¸¸æ‰“å¼€
- âœ… æ— é”™è¯¯å¼¹çª—
- âœ… ç•Œé¢æ­£å¸¸æ˜¾ç¤º

### 3. å¥åº·æ£€æŸ¥éªŒè¯

```powershell
Start-Sleep -Seconds 3
$response = Invoke-WebRequest -Uri "http://127.0.0.1:41731/api/health" -UseBasicParsing -ErrorAction SilentlyContinue
if ($response) {
    Write-Host "âœ… å¥åº·æ£€æŸ¥é€šè¿‡: $($response.Content)"
} else {
    Write-Host "âš ï¸ æ£€æŸ¥å…¶ä»–ç«¯å£..."
    for ($port = 41732; $port -le 41740; $port++) {
        $testUrl = "http://127.0.0.1:$port/api/health"
        $testResponse = Invoke-WebRequest -Uri $testUrl -UseBasicParsing -ErrorAction SilentlyContinue
        if ($testResponse) {
            Write-Host "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ï¼ˆç«¯å£ $portï¼‰: $($testResponse.Content)"
            break
        }
    }
}
```

**é¢„æœŸå“åº”**ï¼š`{"status":"ok"}`

### 4. æ•°æ®åº“è·¯å¾„éªŒè¯

```powershell
$dbPath = "$env:APPDATA\warehouse-app\warehouse.db"
Test-Path $dbPath
Get-Item $dbPath | Select-Object FullName, Length
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ•°æ®åº“æ–‡ä»¶åœ¨ï¼š`C:\Users\<ç”¨æˆ·å>\AppData\Roaming\warehouse-app\warehouse.db`

### 5. æ—¥å¿—è·¯å¾„éªŒè¯

```powershell
$logDir = "$env:APPDATA\warehouse-app\logs"
Get-ChildItem $logDir | Sort-Object LastWriteTime -Descending | Select-Object -First 1
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ—¥å¿—æ–‡ä»¶åœ¨ï¼š`C:\Users\<ç”¨æˆ·å>\AppData\Roaming\warehouse-app\logs\app-YYYY-MM-DD.log`

---

## ğŸ“‹ æœ€ç»ˆäº¤ä»˜ä¿¡æ¯

### 1. å®‰è£…åŒ…å®Œæ•´è·¯å¾„

```
D:\ä»“åº“ç®¡ç†\warehouse-app\build-scripts\ä»“åº“ç®¡ç†-1.0.0-Setup.exe
```

### 2. æ–‡ä»¶å¤§å°

æ„å»ºå®Œæˆåæ£€æŸ¥ï¼š
```powershell
Get-Item "D:\ä»“åº“ç®¡ç†\warehouse-app\build-scripts\ä»“åº“ç®¡ç†-1.0.0-Setup.exe" | Select-Object Length, @{Name="SizeMB";Expression={[math]::Round($_.Length / 1MB, 2)}}
```

**é¢„æœŸå¤§å°**ï¼š100-200 MB

### 3. build é…ç½®å…³é”®å­—æ®µï¼ˆæ–‡å­—è¾“å‡ºï¼‰

**NSIS é…ç½®**ï¼š
- `oneClick: true` âœ…ï¼ˆä¸€é”®å®‰è£…ï¼‰
- `allowToChangeInstallationDirectory: false` âœ…ï¼ˆä¸å…è®¸é€‰æ‹©ç›®å½•ï¼‰
- `perMachine: false` âœ…ï¼ˆå®‰è£…åˆ°ç”¨æˆ·ç›®å½•ï¼‰
- `createDesktopShortcut: "always"` âœ…ï¼ˆåˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼ï¼‰
- `createStartMenuShortcut: true` âœ…ï¼ˆåˆ›å»ºå¼€å§‹èœå•å¿«æ·æ–¹å¼ï¼‰

**ASAR é…ç½®**ï¼š
- `asar: true` âœ…
- `asarUnpack: ["**/better-sqlite3/**/*", "**/server/dist/**/*", "**/*.node"]` âœ…

**é’©å­é…ç½®**ï¼š
- `predist:win: "npm run rebuild:native"` âœ…

### 4. æ„å»ºæ—¥å¿—å…³é”®ç‰‡æ®µ

æ‰§è¡Œ `npm run dist:win` æ—¶ï¼Œåº”çœ‹åˆ°ï¼š

```
> warehouse-app@1.0.0 predist:win
> npm run rebuild:native

> warehouse-app@1.0.0 rebuild:native
> electron-rebuild -f -w better-sqlite3
```

è¿™è¯æ˜ `predist:win` é’©å­å·²æ‰§è¡Œã€‚

---

## ğŸš€ æ‰§è¡Œæ„å»ºï¼ˆç°åœ¨ï¼‰

**æ¨èæ–¹å¼**ï¼šåŒå‡»è¿è¡Œæ‰¹å¤„ç†è„šæœ¬

```batch
build-scripts\æ‰§è¡Œæ„å»º-ç”Ÿæˆå®‰è£…åŒ….bat
```

**æˆ– PowerShell æ‰§è¡Œ**ï¼š

```powershell
cd "D:\ä»“åº“ç®¡ç†\warehouse-app"
powershell -ExecutionPolicy Bypass -File "build-scripts\ä¸€é”®æ„å»ºå¹¶ç”Ÿæˆå®‰è£…åŒ….ps1"
```

---

**é…ç½®å·²ç¡®è®¤å¹¶ä¿®æ”¹å®Œæˆï¼Œå¯ä»¥å¼€å§‹æ„å»ºï¼** âœ…
